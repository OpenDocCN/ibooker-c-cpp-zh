<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 11. Custom Libraries"><div class="chapter" id="smallerc-CHP-11">
<h1><span class="label">Chapter 11. </span>Custom Libraries</h1>


<p>We’ve already seen how to include the headers of useful libraries that come
with the Arduino IDE as well as how to add third-party libraries for some of the more
interesting peripherals and sensors. But as you build up your catalog of microcontroller
projects, you’re likely to create some code that you reuse. I regularly employ
the maxim that there are only three numbers in the universe: 0, 1, and many. If you find
a chunk of code you use a second time, you’re in that “many” category
and it is probably time to consider making your own library.</p>

<p>That statement may seem dramatic. It certainly sounds grandiose. Happily, it is a fairly straightforward process and really does make reuse a snap down the road.</p>

<p>I do want to admit that the project in this chapter is bigger than our past projects
in every sense. If remote-control robotic cars don’t spike your interest, feel
free to skip the bulk of this chapter. I would still recommend reading <a data-type="xref" href="#smallerc-CHP-11-SECT-2">“Multifile Projects”</a>
and <a data-type="xref" href="#smallerc-CHP-11-SECT-3.4">“Creating the Library”</a>
to get a sense of the steps involved in writing a library for your own use within the
Arduino IDE. You can safely skip this chapter in favor of exploring an IoT project
in <a data-type="xref" href="ch12.xhtml#smallerc-CHP-12">Chapter 12</a>.</p>






<section data-type="sect1" data-pdf-bookmark="Creating Your Own Library"><div class="sect1" id="smallerc-CHP-11-SECT-1">
<h1>Creating Your Own Library</h1>

<p>To get<a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="creating custom" id="ardIDE-library-custom"/><a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="creating custom" id="libraries-arduino-custom"/><a data-type="indexterm" data-primary="custom libraries" id="custom-libraries"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" id="libraries-custom"/> started on a custom library, you’ll need some code to reuse. The best
way to find reusable code is to create some usable code first. We can kick off a
normal project and then extract the parts that seem likely to work well in other
projects.</p>

<p>For this project, we’ll create a
motorized car <a data-type="indexterm" data-primary="custom libraries" data-secondary="hardware setup" id="custom-libraries-setup"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="hardware setup" id="libraries-custom-setup"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="hardware setup" id="ardmicro-car-setup"/><a data-type="indexterm" data-primary="car example project" data-secondary="hardware setup" id="car-setup"/>that can be driven with simple forward, backward, left, and right
buttons. Once that is all working, we can break out the various “drive”
functions into a separate file to highlight how the Arduino IDE works with multiple
files. And finally, with a little multifile experience in your back pocket, we’ll
make the leap to radio control and see how to encapsulate that communication in a library
that can be shared between our car and a separate navigation project.</p>

<p><a data-type="xref" href="#smallerc-CHP-11-FIG-robot-car-pic">Figure 11-1</a> shows the setup we’re going to use. I bought these
parts from Adafruit, but you can assemble a similar car from other parts just
as easily. (See <a data-type="xref" href="app02.xhtml#smallerc-APP-B">Appendix B</a> for the exact part numbers I used.) The
physical car is reasonably simple, but definitely requires some assembly. I had
to make a trip to my local hardware store for a few of the small machine screws,
but the prefabricated chassis from Adafruit sure made things simpler. The chassis
has perfect holes and sockets to guide the attachment of both the rear motors and
the loose caster on the front. I just rested a breadboard and battery on top, but
there are ample spots to mount these with clips, screws, or zip ties.</p>

<figure><div id="smallerc-CHP-11-FIG-robot-car-pic" class="figure">
<img src="Images/smac_1101.png" alt="smac 1101" width="2896" height="2898"/>
<h6><span class="label">Figure 11-1. </span>Our robot car</h6>
</div></figure>

<p><a data-type="xref" href="#smallerc-CHP-11-FIG-robot-car-wiring">Figure 11-2</a> shows the wiring of our microcontroller, navigation joystick,
and the DRV8833 motor driver breakout board. There are a lot more connections on this project,
but hopefully not so many that you are overwhelmed.</p>

<figure><div id="smallerc-CHP-11-FIG-robot-car-wiring" class="figure">
<img src="Images/smac_1102.png" alt="smac 1102" width="1441" height="1095"/>
<h6><span class="label">Figure 11-2. </span>Wiring for the robot car</h6>
</div></figure>

<p>Robotics in general is a big interest of mine, but the mechanical elements are (way) out of my field of expertise. The extra learning required to pull off this project my first time around was challenging but fun—at least more fun than frustrating. I’ve never worked with motors before, so getting them mounted, powered, and properly connected so I could control them through software certainly required a little trial and error and no small amount of exasperated utterances. But if this particular project does not hold much interest for you, feel free to just follow along with the deconstruction of our code and see how to pull those parts back together in a library. But I will say that the first time you make a wheel spin by pressing a button, you feel like you can conquer the world. :)</p>
<div data-type="tip"><h6>Tip</h6>
<p>If looking at the diagram in <a data-type="xref" href="#smallerc-CHP-11-FIG-robot-car-wiring">Figure 11-2</a>
gives you the heebie-jeebies, you can look for robotic car kits that come with all
the necessary parts as well as detailed assembly instructions. The kits usually
have their own coding instructions, too. Feel free to get the kit running “as is”
and get comfortable with the electronics first. Then come back here to work through my code
examples and apply them (probably with a few modifications that will reinforce the work
we’re doing here) to your fully functioning <a data-type="indexterm" data-primary="custom libraries" data-secondary="hardware setup" data-startref="custom-libraries-setup" id="idm45018713900968"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="hardware setup" data-startref="libraries-custom-setup" id="idm45018713899752"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="hardware setup" data-startref="ardmicro-car-setup" id="idm45018713898264"/><a data-type="indexterm" data-primary="car example project" data-secondary="hardware setup" data-startref="car-setup" id="idm45018713896760"/>car.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="Preprocessor Directives"><div class="sect2" id="smallerc-CHP-11-SECT-1.1">
<h2>Preprocessor Directives</h2>

<p>We’ve <a data-type="indexterm" data-primary="custom libraries" data-secondary="preprocessor directives" id="idm45018713892920"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="preprocessor directives" id="idm45018713891912"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="preprocessor directives" id="idm45018713890696"/><a data-type="indexterm" data-primary="car example project" data-secondary="preprocessor directives" id="idm45018713889512"/><a data-type="indexterm" data-primary="preprocessor directives for custom libraries" id="idm45018713888568"/>seen a couple of preprocessor directives already: <code>#include</code> and <code>#define</code>
are both handled by the preprocessor. And the name “preprocessor” probably
gives you a hint about its role in compiling your code. These directives are processed
before your code is compiled.</p>

<p>The <code>#include</code> directive is<a data-type="indexterm" data-primary="#include directive" data-primary-sortas="include directive" id="idm45018713886024"/> used to bring in code defined in a separate file. After
inclusion, it looks to the compiler as if you had typed in that external file as part
of your own code.</p>

<p>The <code>#define</code> directive, <a data-type="indexterm" data-primary="#define directive" data-primary-sortas="define directive" id="define-directive"/>as we’ve been using it, puts a human-friendly name on
some literal. We can then use the name in our code rather than remembering the correct
literal every time. And if we ever need to change that value, say, move an LED connection
to a different pin on our controller, we only need to change it once. As with <code>#include</code>,
the preprocessor replaces each instance of a <code>#define</code> name with its literal as though
you had typed the literal directly.</p>

<p>For our car, let’s use <code>#define</code> for the pins on our navigation joystick as
we have with other connected peripherals:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#define LEFT_BTN  12</code>
<code class="cp">#define RIGHT_BTN  9</code>
<code class="cp">#define FWD_BTN   10</code>
<code class="cp">#define BKWD_BTN  11</code></pre>

<p>I should point out that you can use <code>#define</code> with values other than numbers. Perhaps
you have a standard error message or text response. Those can be defined, too:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#define GOOD_STATUS  "OK"</code>
<code class="cp">#define BAD_STATUS   "ERROR"</code>
<code class="cp">#define NO_STATUS    "UNKNOWN"</code></pre>

<p>Knowing how <code>#define</code> works with the preprocessor also explains why we don’t put
a semicolon at the end. We don’t want the semicolon showing up in our code, after
all.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Preprocessor Macros"><div class="sect2" id="smallerc-CHP-11-SECT-1.2">
<h2>Preprocessor Macros</h2>

<p>You <a data-type="indexterm" data-primary="custom libraries" data-secondary="preprocessor macros" id="idm45018713872328"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="preprocessor macros" id="idm45018713871320"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="preprocessor macros" id="idm45018713869976"/><a data-type="indexterm" data-primary="car example project" data-secondary="preprocessor macros" id="idm45018713868792"/><a data-type="indexterm" data-primary="preprocessor macros" data-secondary="for custom libraries" data-secondary-sortas="custom libraries" id="idm45018713867848"/><a data-type="indexterm" data-primary="macros" data-see="preprocessor macros" id="idm45018713866632"/>can take <code>#define</code> a step further as well. Not only does it handle strings, it can
handle small pieces of logic, almost like a function. These snippets are often referred
to as <em>macros</em> to distinguish them from actual functions. A macro (or macroinstruction) transforms some bit of input to a corresponding bit of output, typically via substitutions.
Macros are not function calls. Macros are not pushed onto or popped off of the stack.</p>

<p>Macros are great when you have a repeated bit of code that just doesn’t rise to
the level of needing a function. They are also great when you want your snippet to
remain data-type agnostic. For example, consider a simple macro to determine the minimum
of two values. Here’s the definition and an example of how to use it:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#define MIN (x,y) x &lt; y ? x : y</code>

<code class="kt">int</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">int</code> <code class="n">smaller1</code> <code class="o">=</code> <code class="n">MIN</code><code class="p">(</code><code class="mi">9</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>
  <code class="kt">float</code> <code class="n">smaller2</code> <code class="o">=</code> <code class="n">MIN</code><code class="p">(</code><code class="mf">1.414</code><code class="p">,</code> <code class="mf">3.1415</code><code class="p">);</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>To create the macro, we use <code>#define</code> and a name, like before, but then we supply
a variable (or variables) in parentheses. Whatever arguments you pass to the macro
replace the variables in the macro’s snippet. That snippet, in turn, replaces
the spot where it was called. It’s as if you had typed the following:</p>

<pre data-type="programlisting" data-code-language="c"><code class="kt">int</code> <code class="nf">main</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">int</code> <code class="n">smaller1</code> <code class="o">=</code> <code class="mi">9</code> <code class="o">&lt;</code> <code class="mi">5</code> <code class="o">?</code> <code class="mi">9</code> <code class="o">:</code> <code class="mi">5</code><code class="p">;</code>
  <code class="kt">float</code> <code class="n">smaller2</code> <code class="o">=</code> <code class="mf">1.414</code> <code class="o">&lt;</code> <code class="mf">3.1415</code> <code class="o">?</code> <code class="mf">1.414</code> <code class="o">:</code> <code class="mf">3.1415</code><code class="p">;</code>
<code class="p">}</code></pre>

<p>That simple replacement process can be powerful. But do be careful. Because the
replacement is so simple, you can create problems if you pass complex expressions
to your macro. If, say, your expression uses an operator of lower precedence than
one used in your macro, the intended outcome can be wrong or even uncompilable.
You can avoid some of these problems with judicious use of parentheses, like this:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#define MIN (x,y) (x) &lt; (y) ? (x) : (y)</code></pre>

<p>Even then you <a data-type="indexterm" data-primary="#define directive" data-primary-sortas="define directive" data-startref="define-directive" id="idm45018713735720"/>can create some odd code by passing just the right (er, wrong) expressions.
The GNU documentation on C and the C preprocessor even has an entire section devoted
to <a href="https://oreil.ly/aKdZT">macro pitfalls</a>.</p>

<p>We don’t need any macros just yet, but they’re common enough that I want
you to recognize them if you find them in the wild. The C preprocessor is actually
quite an interesting entity in its own right. It’s a great target for some
independent research after you finish this book!</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Custom Type Definitions"><div class="sect2" id="smallerc-CHP-11-SECT-1.3">
<h2>Custom Type Definitions</h2>

<p>Beyond <a data-type="indexterm" data-primary="custom libraries" data-secondary="type definitions" id="custom-libraries-typedef"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="type definitions" id="libraries-custom-typedef"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="type definitions" id="ardmicro-car-typedef"/><a data-type="indexterm" data-primary="car example project" data-secondary="type definitions" id="car-typedef"/><a data-type="indexterm" data-primary="type definitions" id="type-definitions"/><a data-type="indexterm" data-primary="typedef operator" id="typedef-operator"/>constants and macros, libraries often make use of another feature of C: the
<code>typedef</code> operator. You can use <code>typedef</code> to assign an alias to some other type.
That might sound unnecessary, and it technically is, but there are several cases where
it is very convenient and leads to more readable, maintainable code.</p>

<p>We saw the use of some of these <code>typedef</code> aliases in <a data-type="xref" href="ch10.xhtml#smallerc-CHP-10">Chapter 10</a>. The <code>byte</code>,
<code>uint8_t</code>, and <code>uint32_t</code> specifiers were all created with <code>typedef</code>. If the Arduino
environment didn’t provide those for you, you could create them yourself like
so:</p>

<pre data-type="programlisting" data-code-language="c"><code class="k">typedef</code> <code class="kt">unsigned</code> <code class="kt">char</code> <code class="n">byte</code><code class="p">;</code>
<code class="k">typedef</code> <code class="kt">unsigned</code> <code class="kt">char</code> <code class="kt">uint8_t</code><code class="p">;</code>
<code class="k">typedef</code> <code class="kt">unsigned</code> <code class="kt">long</code> <code class="kt">int</code> <code class="kt">uint32_t</code><code class="p">;</code></pre>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>The “_t” suffix is popular for these aliases. It’s an easy way to
highlight the fact that the name is an alias built with <code>typedef</code>.</p>
</div>

<p>You can also use <code>typedef</code> with the <code>struct</code> keyword to make more palatable names for
your custom, rich data types. For example, we could have used <code>typedef</code> in <a data-type="xref" href="ch06.xhtml#smallerc-CHP-6-SECT-5.1">“Defining Structures”</a>
and defined our transaction like this:</p>

<pre data-type="programlisting" data-code-language="c"><code class="k">typedef</code> <code class="k">struct</code> <code class="n">transaction</code> <code class="p">{</code>
  <code class="kt">double</code> <code class="n">amount</code><code class="p">;</code>
  <code class="kt">int</code> <code class="n">day</code><code class="p">,</code> <code class="n">month</code><code class="p">,</code> <code class="n">year</code><code class="p">;</code>
<code class="p">}</code> <code class="kt">transaction_t</code><code class="p">;</code>

<code class="c1">// Transaction variables can now be declared like this:</code>
<code class="kt">transaction_t</code> <code class="n">bill</code><code class="p">;</code>
<code class="kt">transaction_t</code> <code class="n">deposit</code><code class="p">;</code></pre>

<p>This feature is not something strictly necessary for our simple library, but many libraries do
use <code>typedef</code> to provide names for types that make more sense in the context of the library
or that are simply easier to work with. Let’s go ahead and define a type for any variables
that might store one of our direction constants:</p>

<pre data-type="programlisting" data-code-language="c"><code class="k">typedef</code> <code class="kt">signed</code> <code class="kt">char</code> <code class="kt">direction_t</code><code class="p">;</code></pre>

<p>We’ll stick with the signed version of <code>char</code> since we might find uses for negative
values down the road. Negative numbers make great error codes if you are otherwise only
expecting positive numbers, for example. Now let’s use our new type to create some
typed constants:</p>

<pre data-type="programlisting" data-code-language="c"><code class="k">const</code> <code class="kt">direction_t</code> <code class="n">STOP</code>     <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">LEFT</code>     <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">RIGHT</code>    <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">FORWARD</code>  <code class="o">=</code> <code class="mi">3</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">BACKWARD</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code></pre>

<p>Recall the discussion of <code>const</code> versus <code>#define</code> in <a data-type="xref" href="ch09.xhtml#smallerc-CHP-9-SIDEBAR-const-define">“Constants: const versus #define”</a>.
This is one of those spots where we aren’t really doing anything that demands one approach
or the other, but the <code>const</code> approach does add some inherent documentation to our
code that could be useful to other readers. And I should say that 90% of the time the
first “other reader” that sees your code is you, but you after a few weeks
or months away from the project. Hints about your intentions like the <code>direction_t</code> type
can be very useful in jogging your own <a data-type="indexterm" data-primary="custom libraries" data-secondary="type definitions" data-startref="custom-libraries-typedef" id="idm45018713392824"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="type definitions" data-startref="libraries-custom-typedef" id="idm45018713391608"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="type definitions" data-startref="ardmicro-car-typedef" id="idm45018713390152"/><a data-type="indexterm" data-primary="car example project" data-secondary="type definitions" data-startref="car-typedef" id="idm45018713388696"/><a data-type="indexterm" data-primary="type definitions" data-startref="type-definitions" id="idm45018713387480"/><a data-type="indexterm" data-primary="typedef operator" data-startref="typedef-operator" id="idm45018713386536"/>memory.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Our Car Project"><div class="sect2" id="smallerc-CHP-11-SECT-1.4">
<h2>Our Car Project</h2>

<p>Let’s <a data-type="indexterm" data-primary="custom libraries" data-secondary="car project initial version" id="custom-libraries-carinitial"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="car project initial version" id="libraries-custom-carinitial"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="initial software setup" id="ardmicro-car-initial"/><a data-type="indexterm" data-primary="car example project" data-secondary="initial software setup" id="car-initial"/>get going! This will be our “version one” project with some extra
abstraction that should help as we break up this project into reusable pieces.
(You can take a look at
<a href="https://oreil.ly/Mr2ED">version 0</a> if you want to start
with a simple proof of functionality.) As you work with your own project, you may not have
the motors wired up exactly as I do. Your navigation input (buttons or a joystick)
might be connected a little differently. Test out your setup and don’t be afraid of
changing which pins get set <code>HIGH</code> or <code>LOW</code> in the various driving functions. Happily, that can all be tweaked here in software. The end goal is simply to get your car to roll forward when you push the joystick up.</p>

<p>Here’s version 1 of our car build. As always, you can type this up yourself or just open
<a href="https://oreil.ly/8kqQL"><em>ch11/car1/car1.ino</em></a>:</p>

<pre data-type="programlisting" data-code-language="c"><code class="c1">// Define the pins we're using for the joystick and the motor</code>
<code class="cp">#define LEFT_BTN  12</code>
<code class="cp">#define RIGHT_BTN  9</code>
<code class="cp">#define FWD_BTN   10</code>
<code class="cp">#define BKWD_BTN  11</code>

<code class="cp">#define AIN1 4</code>
<code class="cp">#define AIN2 5</code>
<code class="cp">#define BIN1 6</code>
<code class="cp">#define BIN2 7</code>

<code class="c1">// Define our direction type</code>
<code class="k">typedef</code> <code class="kt">char</code> <code class="kt">direction_t</code><code class="p">;</code>

<code class="c1">// Define our direction constants</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">STOP</code>     <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">LEFT</code>     <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">RIGHT</code>    <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">FORWARD</code>  <code class="o">=</code> <code class="mi">3</code><code class="p">;</code>
<code class="k">const</code> <code class="kt">direction_t</code> <code class="n">BACKWARD</code> <code class="o">=</code> <code class="mi">4</code><code class="p">;</code>

<code class="kt">void</code> <code class="nf">setup</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// Tell our board we want to write to the built-in LED</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">LED_BUILTIN</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>

  <code class="c1">// Accept input from the joystick pins</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">LEFT_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">RIGHT_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">FWD_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">BKWD_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>

  <code class="c1">// Send output to the motor pins</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>

  <code class="c1">// And make sure our LED is off</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">LED_BUILTIN</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">allstop</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">forward</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">backward</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">left</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">right</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">direction_t</code> <code class="nf">readDirection</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">FWD_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">FORWARD</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">BKWD_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">BACKWARD</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">LEFT_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">LEFT</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">RIGHT_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">RIGHT</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="c1">// No buttons were pressed, so return STOP</code>
  <code class="k">return</code> <code class="n">STOP</code><code class="p">;</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">loop</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">direction_t</code> <code class="n">dir</code> <code class="o">=</code> <code class="n">readDirection</code><code class="p">();</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">dir</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// Driving!</code>
    <code class="n">digitalWrite</code><code class="p">(</code><code class="n">LED_BUILTIN</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
    <code class="k">switch</code> <code class="p">(</code><code class="n">dir</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">case</code> <code class="nl">FORWARD</code><code class="p">:</code>
        <code class="n">forward</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="k">case</code> <code class="nl">BACKWARD</code><code class="p">:</code>
        <code class="n">backward</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="k">case</code> <code class="nl">LEFT</code><code class="p">:</code>
        <code class="n">left</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="k">case</code> <code class="nl">RIGHT</code><code class="p">:</code>
        <code class="n">right</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="c1">// Stopping, or eventually we could handle errors, too</code>
    <code class="n">digitalWrite</code><code class="p">(</code><code class="n">LED_BUILTIN</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
    <code class="n">allstop</code><code class="p">();</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Feel free to take a break from the book at this point and just have some fun. :) Can you
drive both forward and backward? When you move the joystick left or right, does the car
turn the way you want? Can you parallel park between two stuffed animal obstacles? It might
feel a little awkward following your car around with the tethered joystick, but we’ll
fix that<a data-type="indexterm" data-primary="custom libraries" data-secondary="car project initial version" data-startref="custom-libraries-carinitial" id="idm45018713373592"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="car project initial version" data-startref="libraries-custom-carinitial" id="idm45018713372408"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="initial software setup" data-startref="ardmicro-car-initial" id="idm45018713370920"/><a data-type="indexterm" data-primary="car example project" data-secondary="initial software setup" data-startref="car-initial" id="idm45018713369416"/><a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="creating custom" data-startref="ardIDE-library-custom" id="idm45018712968584"/><a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="creating custom" data-startref="libraries-arduino-custom" id="idm45018712967096"/><a data-type="indexterm" data-primary="custom libraries" data-startref="custom-libraries" id="idm45018712965592"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-startref="libraries-custom" id="idm45018712964648"/> shortly.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Multifile Projects"><div class="sect1" id="smallerc-CHP-11-SECT-2">
<h1>Multifile Projects</h1>

<p>Welcome<a data-type="indexterm" data-primary="Arduino IDE" data-secondary="multifile projects" id="ardIDE-multifile"/><a data-type="indexterm" data-primary="multifile projects" id="multifile"/> back! Hope you managed to safely parallel park your new roadster. With a
working program as our baseline, let’s break it up into some reusable parts.</p>

<p>C, as a language, does not really worry about where your code lives. As long as <em>gcc</em> can find all of the source files, header files, and libraries you mention in your code, it will produce usable output. Creating multifile projects for the Arduino IDE is a little different, however. The IDE manages some integration steps that would normally be left to you on the desktop. Since we’re concentrating on microcontrollers at this point, we’ll stick to what needs to be done in the Arduino IDE. If you are curious about building larger projects outside of Arduino, I’ll again recommend Prinz and Crawford’s
<a href="https://www.oreilly.com/library/view/c-in-a/0596006977/" class="orm:hideurl"><em>C in a Nutshell</em></a>.</p>

<p>We’ll start by converting our current project into a multifile project with
no change in functionality. Then we’ll extend our robot car to support remote
radio control and see how powerful shared code can be.</p>

<p>In our small car example, we have several functions devoted to making the car move.
Those related functions are perfect for separating into their own file. They all serve a
similiar purpose. Their related purpose is not necessary for creating
separate files, but it’s a popular means of organizing the pieces of a larger
project. A small number of files, each with a small number of functions, can be easier
to maintain and debug than a huge file with lots of functions. But if you break up functions
randomly, it will be difficult to remember which files contain which functions.</p>

<p>The Arduino IDE gives us a few options for breaking up our projects: we can add new
<em>.ino</em> files, we can include custom header files, or we can create and then import a
custom library. The rest of this chapter looks at all three of these mechanisms.</p>








<section data-type="sect2" data-pdf-bookmark="Code (.ino) Files"><div class="sect2" id="smallerc-CHP-11-SECT-2.1">
<h2>Code (.ino) Files</h2>

<p>To <a data-type="indexterm" data-primary="Arduino IDE" data-secondary="multifile projects" data-tertiary=".ino files" data-tertiary-sortas="ino files" id="ardIDE-multifile-ino"/><a data-type="indexterm" data-primary="multifile projects" data-secondary=".ino files" data-secondary-sortas="ino files" id="multifile-ino"/><a data-type="indexterm" data-primary=".ino files" data-primary-sortas="ino files" id="ino-files"/><a data-type="indexterm" data-primary="Arduino IDE" data-secondary=".ino files" data-secondary-sortas="ino files" id="ardIDE-ino"/>start, let’s save this project under a new name so that we have a
backup in case something goes awry and we want to refer back to a working project.
From the “File” menu in the Arduino IDE, select the “Save As…”
option. I chose the highly creative and original name <em>car2</em>. You are free to be
as creative or even more so if the muse strikes.</p>

<p>Now let’s take all five of our driving functions and move them to their own file.
To add a new file, use the downward pointing triangle button on the
right-hand side near the top. That button opens a small menu, as shown in
<a data-type="xref" href="#smallerc-CHP-11-FIG-ide-new-tab">Figure 11-3</a>. Select “New Tab” from that menu.</p>

<figure><div id="smallerc-CHP-11-FIG-ide-new-tab" class="figure">
<img src="Images/smac_1103.png" alt="smac 1103" width="1262" height="473"/>
<h6><span class="label">Figure 11-3. </span>Creating a new tab in the Arduino IDE</h6>
</div></figure>

<p>Next, you’ll be prompted to name the tab, as shown in
<a data-type="xref" href="#smallerc-CHP-11-FIG-ide-name-new-tab">Figure 11-4</a>. Enter
the name <strong><code>drive.ino</code></strong> in the field and then click the OK button.</p>

<figure><div id="smallerc-CHP-11-FIG-ide-name-new-tab" class="figure">
<img src="Images/smac_1104.png" alt="smac 1104" width="1441" height="1271"/>
<h6><span class="label">Figure 11-4. </span>Naming our new file</h6>
</div></figure>

<p>You should now have a new tab named “drive” (with no suffix showing). Go
ahead and cut the five driving functions (including <code>allstop()</code>) from the “car2”
tab and then paste them into our new “drive” tab. That tab will end up with
the following code
(<a href="https://oreil.ly/pRodD"><em>ch11/car2/drive.ino</em></a>):</p>

<pre data-type="programlisting" data-code-language="c"><code class="kt">void</code> <code class="nf">allstop</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">forward</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">backward</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">left</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">right</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">HIGH</code><code class="p">);</code>
  <code class="n">digitalWrite</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">LOW</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>That’s actually all the work required to separate these pieces of code! You now have
your first multifile Arduino project. Click the Verify (checkmark) button to make sure your project
still compiles in its new, two-file configuration. Everything should still work. You can
even upload this to your controller and still drive your car.</p>

<p>If the project does not verify or upload, check to make sure you didn’t drop a curly brace
or perhaps grab an extra line from the original file. You should also make sure the name
you picked for your newly separated file ends with that <em>.ino</em> extension.</p>

<p class="pagebreak-before less_space">The Arduino IDE performs a little magic for us with <em>.ino</em> files. Our main project file
(<em>car2.ino</em> in the <em>car2</em> folder, in this case) is prepared first. Any other <em>.ino</em> files
will then be included in alphabetical order. You may have noticed that our <em>drive.ino</em> file
has no <code>#include</code> statements. And yet, we clearly use the pin constants defined in our main
file. As far as the compiler is concerned, there is
only one large <em>.ino</em> file to compile, so successive <em>.ino</em> files see all of the functions,
<code>#defines</code>, and global variables from the files that came before. At this time, there is no
way to change the order of the separate <em>.ino</em> files; they are always incorporated
<a data-type="indexterm" data-primary="Arduino IDE" data-secondary="multifile projects" data-tertiary=".ino files" data-tertiary-sortas="ino files" data-startref="ardIDE-multifile-ino" id="idm45018712791832"/><a data-type="indexterm" data-primary="multifile projects" data-secondary=".ino files" data-secondary-sortas="ino files" data-startref="multifile-ino" id="idm45018712790040"/><a data-type="indexterm" data-primary=".ino files" data-primary-sortas="ino files" data-startref="ino-files" id="idm45018712788552"/><a data-type="indexterm" data-primary="Arduino IDE" data-secondary=".ino files" data-secondary-sortas="ino files" data-startref="ardIDE-ino" id="idm45018712787336"/>alphabetically.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Header Files"><div class="sect2" id="smallerc-CHP-11-SECT-2.2">
<h2>Header Files</h2>

<p>So how <a data-type="indexterm" data-primary="Arduino IDE" data-secondary="multifile projects" data-tertiary="header files" id="ardIDE-multifile-header"/><a data-type="indexterm" data-primary="multifile projects" data-secondary="header files" id="multifile-header"/><a data-type="indexterm" data-primary="header files" data-secondary="in multifile projects" data-secondary-sortas="multifile projects" id="headers-multifile"/><a data-type="indexterm" data-primary="#define directive" data-secondary="in header files" data-primary-sortas="define directive" data-secondary-sortas="header files" id="define-directive-header"/>can all these separate files work together so seamlessly? The IDE adds one more piece of magic before loading these separate files. It creates a header file <a data-type="indexterm" data-primary="forward declarations" id="idm45018712777432"/>with <em>forward declarations</em> of all of the functions and global variables in your <em>.ino</em> file. Forward declarations are brief descriptions of what your function is named, what parameters it has, and what type of value it will return. They allow separate files to use a function without needing to have its full implementation. Each header, in turn, is automatically included in your main project file.</p>

<p>You can see the effect of this in our simple two-tab project. The <em>drive.ino</em> file does
not need to include any extra information to make use of our <code>#define</code> pin entries. And
the code in our main <em>car2.ino</em> file can call the functions defined in <em>drive.ino</em> without
worrying about the ordering or specific location of the functions. In the end, both files
fit together perfectly to complete our project.</p>

<p>You can also create your own header files. This can be nice for housekeeping. For
example, if you have many <code>#define</code> statements, you could place them in their own header.
Or if you want a low-tech means of sharing some directives between projects, you can make
a copy of a header and put it in another project. It is largely up to you what makes the
most sense for your own projects. Many successful makers out there have dozens or hundreds
of projects each with one single <em>.ino</em> file. I just want to make sure you know how to
split things into more manageable pieces if that one big file starts to overwhelm you.</p>

<p>In service of that goal, let’s break up our main project just a little more. Let’s
try the trick of putting some of our <code>#define</code> directives in their own header file. We’ll
move the eight pin constants. Create a new tab as before, and name it <strong><code>pins.h</code></strong> when
prompted. The new tab should show the full name of the file, <em>pins.h</em>, to help
distinguish it from <em>.ino</em> files that hide the extension.</p>

<p class="pagebreak-before less_space">Cut the eight <code>#define</code> lines and the relevant comments from <em>car2</em> and paste them into <em>pins.h</em>.
The result should look like
<a href="https://oreil.ly/pwQM6"><em>ch11/car2/pins.h</em></a>:</p>

<pre data-type="programlisting" data-code-language="c"><code class="c1">// Define the pins we're using for the joystick and the motor</code>

<code class="cp">#ifndef PINS_H</code>
<code class="cp">#define PINS_H</code>

<code class="cp">#define LEFT_BTN  12</code>
<code class="cp">#define RIGHT_BTN  9</code>
<code class="cp">#define FWD_BTN   10</code>
<code class="cp">#define BKWD_BTN  11</code>

<code class="cp">#define AIN1 4</code>
<code class="cp">#define AIN2 5</code>
<code class="cp">#define BIN1 6</code>
<code class="cp">#define BIN2 7</code>

<code class="cp">#endif </code><code class="cm">/* PINS_H */</code><code class="cp"/></pre>
<aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="smallerc-CHP-11-SIDEBAR-include-guard">
<h5>Preventing Duplicate Includes</h5>
<p>The <a data-type="indexterm" data-primary="#include directive" data-secondary="preventing duplicates" data-primary-sortas="include directive" id="idm45018712748792"/>first and last lines in <em>pins.h</em> might look a <a data-type="indexterm" data-primary="#ifndef directive" data-primary-sortas="ifndef directive" id="idm45018712747064"/><a data-type="indexterm" data-primary="#endif directive" data-primary-sortas="endif directive" id="idm45018712746056"/>little strange. <code>#ifndef</code> and <code>#endif</code>
are more preprocessor directives. <code>#ifndef</code> checks to see if a given name is “Not
DEFined,” and <code>#endif</code> is the end of that block, much like a closing curly brace
ends a block statement in C. (There is <a data-type="indexterm" data-primary="#ifdef directive" data-primary-sortas="ifdef directive" id="idm45018712743176"/>also a <code>#ifdef</code> directive to test if
a particular term is defined.)</p>

<p>Combined with the empty <code>#define PINS_H</code> line,
these directives form <a data-type="indexterm" data-primary="include guards" id="idm45018712740856"/>an <em>include guard</em>. They prevent this header file from being
included multiple times. Or more precisely, they prevent the contents of the header
from being processed multiple times. This makes it safe to include a header, even if some other header may have already included the same header.</p>

<p>You’ll likely see these <code>#ifdef</code> and <code>#ifndef</code> statements in many headers.
They are a handy tool for environments that have to accommodate different values
for different situations. In the Arduino IDE, for example, when you select a
new development board, a series of these defined/not-defined tests makes sure
that constants like <code>LED_BUILTIN</code> have the correct pin assigned for the board
you chose.</p>
</div></aside>

<p>Now we just need to add an include statement to our <em>car2</em> tab at the
top of our file:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#include "pins.h"</code></pre>

<p>You<a data-type="indexterm" data-primary="#define directive" data-secondary="in header files" data-primary-sortas="define directive" data-secondary-sortas="header files" data-startref="define-directive-header" id="idm45018712483160"/> can check your work against my
<a href="https://oreil.ly/EWAV9">version 2</a>.
Your project should still verify (and upload) just as before. Feel free to give it
a try and make sure you can still drive your car.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Pay close attention to the double quotes around our <em>pins.h</em> header name.
Previous <code>#include</code> statements <a data-type="indexterm" data-primary="#include directive" data-secondary="angle brackets versus quotes" data-primary-sortas="include directive" id="idm45018712492488"/>used angle brackets (&lt;&gt;: less than,
greater than). The distinction is intentional. The angle brackets tell the
compiler to look for the header in the standard include path. Typically,
that means you are bringing in a header from a known library.</p>

<p>The quotes tell the compiler the file to be included is in the same folder
as the file doing the including. Typically, that means you are bringing in
a header file you wrote specifically for this project.</p>
</div>

<p>Again, divvying up a project is
not a requirement or something you always do with large files, but it can be helpful.
It allows you to concentrate on one part of your code without accidentally changing another
part. If you collaborate with other programmers, working on separate files can also make
it easier to combine your efforts at the end. In the end, though, it really is up to
you and what you feel comfortable<a data-type="indexterm" data-primary="Arduino IDE" data-secondary="multifile projects" data-tertiary="header files" data-startref="ardIDE-multifile-header" id="idm45018712489272"/><a data-type="indexterm" data-primary="multifile projects" data-secondary="header files" data-startref="multifile-header" id="idm45018712459656"/><a data-type="indexterm" data-primary="header files" data-secondary="in multifile projects" data-secondary-sortas="multifile projects" data-startref="headers-multifile" id="idm45018712458440"/><a data-type="indexterm" data-primary="Arduino IDE" data-secondary="multifile projects" data-startref="ardIDE-multifile" id="idm45018712456952"/><a data-type="indexterm" data-primary="multifile projects" data-startref="multifile" id="idm45018712455736"/> with.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="Importing Custom Libraries"><div class="sect1" id="smallerc-CHP-11-SECT-3">
<h1>Importing Custom Libraries</h1>

<p>Beyond<a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="creating custom" id="ardIDE-library-customcreate"/><a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="creating custom" id="libraries-arduino-customcreate"/> multiple <em>.ino</em> and <em>.h</em> files, though, you can also build your own Arduino
IDE library. If you have code that you want to use in multiple projects or perhaps
share with others via public code sites like GitHub, a library is a great choice.</p>

<p>Happily, creating a custom library doesn’t require too much effort. You need
at least one <em>.cpp</em> file and a matching header (<em>.h</em>) file. You can have more files,
if needed, as well as a few niceties we’ll discuss in the next section.</p>








<section data-type="sect2" data-pdf-bookmark="Facilitating Communication"><div class="sect2" id="smallerc-CHP-11-SECT-3.1">
<h2>Facilitating Communication</h2>

<p>Our <a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="purpose of" id="custom-libraries-radio-purpose"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="radio control example" id="libraries-custom-radio"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="radio control setup" id="ardmicro-car-radio"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="purpose of" id="car-radio-purpose"/><a data-type="indexterm" data-primary="radio control project" data-secondary="purpose of" id="radio-purpose"/>robot car is spiffy, but following it around with a tethered joystick is clunky.
A <em>radio-controlled</em> robot car would be even spiffier! We can do that, and using a
library to manage that radio communication is a great way to guarantee we don’t
cross any signals—literally. We can use a library to make sure multiple parties
have access to common definitions (say, the value for driving “forward”). We
can also put the rules of a protocol into a library’s functions. It’s a
bit like making sure everyone is speaking the same language.</p>

<p>Libraries can supply more than the vocabulary of this hypothetical language. They can
also enforce the rules of conversation. Who speaks first? Who speaks next?
Is a response required? Can there be more than one listener? You answer questions
like these with the functions you write in your library. As long as two (or more) projects
use the same library, the details you encoded in the library’s functions will
make sure everyone plays nicely together.</p>

<p>Let’s create a library to send and receive radio signals. We’ll create two
separate projects that both use this library. We’ll start by replacing the joystick
that is currently wired to our car with a radio component. Then we’ll create a
controller project that pairs our newly liberated joystick with a similar radio. This
does mean we need two microcontrollers, by the way. I’ll use another Metro Mini,
but they don’t have to be identical. If you have some other controller lying around
that is compatible with our radio and can use our library,
any combination of controllers<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="purpose of" data-startref="custom-libraries-radio-purpose" id="idm45018712418520"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="purpose of" data-startref="car-radio-purpose" id="idm45018712416984"/><a data-type="indexterm" data-primary="radio control project" data-secondary="purpose of" data-startref="radio-purpose" id="idm45018712415496"/> should work.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Retrofitting Our Car"><div class="sect2" id="smallerc-CHP-11-SECT-3.2">
<h2>Retrofitting Our Car</h2>

<p>Let’s <a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="retrofitting car for" id="custom-libraries-radio-retro"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="retrofitting car for" id="car-radio-retro"/><a data-type="indexterm" data-primary="radio control project" data-secondary="retrofitting car for" id="radio-retro"/>swap out the joystick for a radio transceiver. I’m using the nicely packaged
<a href="https://oreil.ly/JhUn8">RFM69HCW</a> high-power breakout from Adafruit. It’s about
$10 and is reasonably straightforward to connect. Plus, it comes with some nice features
like encrypted transmissions that can only be decrypted by a similar chip with the same
encryption key (that you provide in code). <a data-type="xref" href="#smallerc-CHP-11-FIG-radio-car-wiring">Figure 11-5</a>
shows the wiring<a data-type="indexterm" data-primary="radio control project" data-secondary="transceiver breakout" id="idm45018712405912"/> diagram for our microcontroller, the motor driver, and our radio. I had to
relocate several of the DRV8833 connections as the RFM69HCW requires the use of specific pins on
our Metro Mini microcontroller (more on that in <a data-type="xref" href="#smallerc-CHP-11-SECT-3.4.2">“Our radio-control library header”</a>).</p>

<figure><div id="smallerc-CHP-11-FIG-radio-car-wiring" class="figure">
<img src="Images/smac_1105.png" alt="smac 1105" width="1441" height="1101"/>
<h6><span class="label">Figure 11-5. </span>Wiring for the robot car with radio transceiver</h6>
</div></figure>

<p>Of course the power and ground pins should be connected as well. I used a 9V for the
microcontroller (which in turn supplies power to the radio)
and a separate power supply for the DRV8833. The lonely green wire
attached to the top of the RFM69HCW is just a three-inch piece of wire serving as the
simplest possible antenna.<sup><a data-type="noteref" id="idm45018712401128-marker" href="ch11.xhtml#idm45018712401128">1</a></sup></p>

<p><a data-type="xref" href="#smallerc-CHP-11-FIG-radio-car-pic">Figure 11-6</a> shows the assembled components, all ready to roll with
no wires attached!</p>

<figure><div id="smallerc-CHP-11-FIG-radio-car-pic" class="figure">
<img src="Images/smac_1106.png" alt="smac 1106" width="2962" height="2980"/>
<h6><span class="label">Figure 11-6. </span>Our wire-free robot car</h6>
</div></figure>

<p class="pagebreak-before less_space">Well, no wires to a joystick, that is. The breadboard is rather
lousy with wires. This <em>is</em> a bigger project than we’ve tackled so far.
If a radio-controlled car isn’t up your alley, feel free to skip to the next
chapter. But before you go, check out
<a data-type="xref" href="#smallerc-CHP-11-SECT-3.4">“Creating the Library”</a> on creating the library code and its header file.</p>

<p>I’m using two separate power supplies to keep the motors separate from the microcontroller
and the radio. If you have more experience powering Arduino projects and want to use a
different configuration, go right ahead! The important part is that we have our radio
ready to receive driving <a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="retrofitting car for" data-startref="custom-libraries-radio-retro" id="idm45018712394184"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="retrofitting car for" data-startref="car-radio-retro" id="idm45018712392696"/><a data-type="indexterm" data-primary="radio control project" data-secondary="retrofitting car for" data-startref="radio-retro" id="idm45018712391208"/>instructions.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Creating a Controller"><div class="sect2" id="smallerc-CHP-11-SECT-3.3">
<h2>Creating a Controller</h2>

<p>We also<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="controller setup" id="custom-libraries-radio-controller"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="controller setup" id="car-radio-controller"/><a data-type="indexterm" data-primary="radio control project" data-secondary="controller setup" id="radio-controller"/><a data-type="indexterm" data-primary="controller setup for radio-controlled car" id="controller-setup"/> need a new project to take input from our joystick and send that information
out over the radio. <a data-type="xref" href="#smallerc-CHP-11-FIG-controller-wiring">Figure 11-7</a> shows the wiring. Only one battery is required
for the controller; the radio can be safely powered from the 5V pin of our microcontroller.</p>

<figure><div id="smallerc-CHP-11-FIG-controller-wiring" class="figure">
<img src="Images/smac_1107.png" alt="smac 1107" width="1435" height="893"/>
<h6><span class="label">Figure 11-7. </span>Wiring for the radio controller</h6>
</div></figure>

<p>I powered the controller with a USB power pack plugged into the Metro Mini.
<a data-type="xref" href="#smallerc-CHP-11-FIG-controller-pic">Figure 11-8</a> shows the final result.</p>

<figure><div id="smallerc-CHP-11-FIG-controller-pic" class="figure">
<img src="Images/smac_1108.png" alt="smac 1108" width="3296" height="2800"/>
<h6><span class="label">Figure 11-8. </span>Our wire-free controller</h6>
</div></figure>

<p>Not the most glamorous of gadgets, but it does send radio signals! At least, it will once
we add a little <a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="controller setup" data-startref="custom-libraries-radio-controller" id="idm45018712375560"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="controller setup" data-startref="car-radio-controller" id="idm45018712373976"/><a data-type="indexterm" data-primary="radio control project" data-secondary="controller setup" data-startref="radio-controller" id="idm45018712372488"/><a data-type="indexterm" data-primary="controller setup for radio-controlled car" data-startref="controller-setup" id="idm45018712371272"/>code.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Creating the Library"><div class="sect2" id="smallerc-CHP-11-SECT-3.4">
<h2>Creating the Library</h2>

<p>The<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="creating library" id="custom-libraries-radio-create"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="creating library" id="car-radio-create"/><a data-type="indexterm" data-primary="radio control project" data-secondary="creating library" id="radio-create"/> code for both our car and our controller will require our radio library, so let’s
start there. We’ll be creating one header file and one <em>.cpp</em> file to accommodate the
<span class="keep-together">C++</span>-centric nature of the Arduino IDE. The actual code will still be (mostly) vanilla C,
it just needs to live in a file with that <em>.cpp</em> extension.</p>

<p>How you go about writing this code is really up to you. You can write everything in one
file and then separate out the parts that go into the header (much like we did earlier in
this chapter). You can also use the header as a sort of outline or plan. Fill out the
header with your constants and names of your functions, then go create the <em>.cpp</em> file
to implement those functions. Regardless of which path sounds better to you, we need to
put the files in a specific place before the IDE will recognize them.</p>










<section data-type="sect3" data-pdf-bookmark="The libraries folder"><div class="sect3" id="smallerc-CHP-11-SECT-3.4.1">
<h3>The libraries folder</h3>

<p>We place<a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries folder" id="idm45018712358520"/><a data-type="indexterm" data-primary="sketches" data-secondary="libraries folder" id="idm45018712357544"/><a data-type="indexterm" data-primary="libraries folder" id="idm45018712356568"/> all of the files for our library inside one folder that goes in the <em>libraries</em> folder
wherever your Arduino sketches live. On my Linux box, that’s the <em>Arduino</em> folder in my home
directory. If you’re not sure where that folder is on your system, you can check the
preferences in the Arduino IDE. From the File menu, select the Preferences option. You should see
a dialog similar to <a data-type="xref" href="#smallerc-CHP-11-FIG-ide-sketch-location">Figure 11-9</a>. Notice the “Sketchbook
location” toward the
top. That’s where the <em>libraries</em> folder needs to go. If there isn’t one there already,
go ahead and create that now.</p>

<figure><div id="smallerc-CHP-11-FIG-ide-sketch-location" class="figure">
<img src="Images/smac_1109.png" alt="smac 1109" width="1441" height="991"/>
<h6><span class="label">Figure 11-9. </span>The Sketchbook location preference setting</h6>
</div></figure>

<p>It’s actually useful that we’re looking at this folder now, since we need to
manually install the <a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="installing" id="idm45018712350552"/><a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="installing" id="idm45018712349304"/><a data-type="indexterm" data-primary="installing" data-secondary="Arduino libraries" id="idm45018712348088"/><a data-type="indexterm" data-primary="downloading" data-secondary="Arduino libraries" id="idm45018712347144"/>library for our radio breakout. It will go in this same folder.
I’m using the
<a href="https://oreil.ly/YLphd">radio library</a> written by the folks at
Adafruit.<sup><a data-type="noteref" id="idm45018712345416-marker" href="ch11.xhtml#idm45018712345416">2</a></sup> Download the ZIP archive from the green “Code” drop-down
button. Unzip that file and rename the resulting folder <strong><code>RadioHead</code></strong>. Place this <em>RadioHead</em>
folder in the <em>libraries</em> folder, and that’s it.</p>

<p>Well, that’s it for the radio library. We still need to make a folder for our own,
yet to be written, library. Inside the <em>libraries</em> folder, create a new folder and pick a
name for your custom library. Since
this is a <em>r</em>adio <em>c</em>ontrol library for a <em>r</em>obot <em>c</em>ar, and the title of this book ends
in those two letters, I chose to name mine <em>SmalleRC</em>. You are under no pressure to use such
delightful, nerdy puns for
your library names, by the way. This is where the “custom” adjective comes in.
Customize your library however you like!</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Our radio-control library header"><div class="sect3" id="smallerc-CHP-11-SECT-3.4.2">
<h3>Our radio-control library header</h3>

<p>Inside<a data-type="indexterm" data-primary="header files" data-secondary="for radio control project" data-secondary-sortas="radio control project" id="headers-radio"/> your new library folder, then, let’s create our files. I’ll use the second
approach and start with the header file,
<a href="https://oreil.ly/koHtr"><em>SmalleRC.h</em></a>.</p>

<p>We’ll load the headers we need for our radio
work as well as the <em>Arduino.h</em> header in case we rely on any Arduino-specific functions in
our library code. We’ll define several constants and then provide some function prototypes:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#</code><code class="cp">ifndef SMALLERC_H                    </code><a class="co" id="co_custom_libraries_CO1-1" href="#callout_custom_libraries_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="cp">
</code><code class="cp">#</code><code class="cp">define SMALLERC_H</code><code class="cp">
</code><code>
</code><code class="cp">#</code><code class="cp">include "Arduino.h"                  </code><a class="co" id="co_custom_libraries_CO1-2" href="#callout_custom_libraries_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code class="cp">
</code><code class="cp">#</code><code class="cp">include &lt;SPI.h&gt;                      </code><a class="co" id="co_custom_libraries_CO1-3" href="#callout_custom_libraries_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code class="cp">
</code><code class="cp">#</code><code class="cp">include &lt;RH_RF69.h&gt;                  </code><a class="co" id="co_custom_libraries_CO1-4" href="#callout_custom_libraries_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code class="cp">
</code><code>
</code><code class="cp">#</code><code class="cp">define RF69_FREQ 915.0               </code><a class="co" id="co_custom_libraries_CO1-5" href="#callout_custom_libraries_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code class="cp">
</code><code class="cp">#</code><code class="cp">define RFM69_CS      4</code><code class="cp">
</code><code class="cp">#</code><code class="cp">define RFM69_INT     3</code><code class="cp">
</code><code class="cp">#</code><code class="cp">define RFM69_RST     2</code><code class="cp">
</code><code class="cp">#</code><code class="cp">define LED          13</code><code class="cp">
</code><code>
</code><code class="cp">#</code><code class="cp">define rc_INIT_SUCCESS  1            </code><a class="co" id="co_custom_libraries_CO1-6" href="#callout_custom_libraries_CO1-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code class="cp">
</code><code class="cp">#</code><code class="cp">define rc_INIT_FAILED  -1</code><code class="cp">
</code><code class="cp">#</code><code class="cp">define rc_FREQ_FAILED  -2</code><code class="cp">
</code><code>
</code><code class="c1">// Define our direction type
</code><code class="k">typedef</code><code> </code><code class="kt">signed</code><code> </code><code class="kt">char</code><code> </code><code class="kt">direction_t</code><code class="p">;</code><code>      </code><a class="co" id="co_custom_libraries_CO1-7" href="#callout_custom_libraries_CO1-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a><code>

</code><code class="c1">// Define our directions
</code><code class="k">const</code><code> </code><code class="kt">direction_t</code><code> </code><code class="n">rc_STOP</code><code>     </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code><code>
</code><code class="k">const</code><code> </code><code class="kt">direction_t</code><code> </code><code class="n">rc_LEFT</code><code>     </code><code class="o">=</code><code> </code><code class="mi">1</code><code class="p">;</code><code>
</code><code class="k">const</code><code> </code><code class="kt">direction_t</code><code> </code><code class="n">rc_RIGHT</code><code>    </code><code class="o">=</code><code> </code><code class="mi">2</code><code class="p">;</code><code>
</code><code class="k">const</code><code> </code><code class="kt">direction_t</code><code> </code><code class="n">rc_FORWARD</code><code>  </code><code class="o">=</code><code> </code><code class="mi">3</code><code class="p">;</code><code>
</code><code class="k">const</code><code> </code><code class="kt">direction_t</code><code> </code><code class="n">rc_BACKWARD</code><code> </code><code class="o">=</code><code> </code><code class="mi">4</code><code class="p">;</code><code>
</code><code>
</code><code class="kt">char</code><code> </code><code class="nf">rc_start</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>                      </code><a class="co" id="co_custom_libraries_CO1-8" href="#callout_custom_libraries_CO1-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a><code>
</code><code class="kt">void</code><code> </code><code class="nf">rc_send</code><code class="p">(</code><code class="kt">int</code><code> </code><code class="n">d</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="kt">int</code><code>  </code><code class="nf">rc_receive</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code class="cp">#</code><code class="cp">endif </code><code class="cm">/* SMALLERC_H */</code></pre>
<dl class="calloutlist pagebreak-before less_space">
<dt><a class="co" id="callout_custom_libraries_CO1-1" href="#co_custom_libraries_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>We’ll use a header guard like we did with <em>pins.h</em>.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO1-2" href="#co_custom_libraries_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Our library code may need some of the Arduino-specific types or functions, so
we include this header. It is automatically included in our main project by the IDE, which is why we haven’t seen this <code>#include</code> before.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO1-3" href="#co_custom_libraries_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>The SPI (<a href="https://oreil.ly/eZmyO">Serial Peripheral Interface</a>) header
allows us to perform complex communication (i.e., something other than <code>HIGH</code> and <code>LOW</code> or single
values) with a peripheral using only a few wires. We’ll use this
type of connection with our radio breakout board. Our microcontroller has very specific pins
for SPI, so we don’t have to specify which ones to use. <a data-type="xref" href="#smallerc-CHP-11-FIG-controller-wiring">Figure 11-7</a>
shows the correct connections to make.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO1-4" href="#co_custom_libraries_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>We’ll need the RH_RF69 library we just installed to talk to the radio.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO1-5" href="#co_custom_libraries_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>While SPI takes care of most communication needs, these <code>define</code> entries fill in some details
needed by the RH_RF69 library to operate our radio, including the frequency to use (<code>RF69_FREQ</code>;
use 433 MHz in Europe and 868 or 915 MHz in the Americas) and which pins handle the interrupts and resets.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO1-6" href="#co_custom_libraries_CO1-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>We’ll define a few of our own constants to help coordinate the initialization
of our radio. We’ll distinguish failures in a way that can help us debug any issues.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO1-7" href="#co_custom_libraries_CO1-7"><img src="Images/7.png" alt="7" width="12" height="12"/></a></dt>
<dd><p>We can put our <code>typedef</code> here so that everyone importing this library has access
to the <code>direction_t</code> type alias. We’ll also include our directions.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO1-8" href="#co_custom_libraries_CO1-8"><img src="Images/8.png" alt="8" width="12" height="12"/></a></dt>
<dd><p>These are the forward declarations (also called function prototypes) for our library.
We’ll need to write the complete functions in our <em>.cpp</em> file, and those functions
will have the same names and parameters as the ones declared here.</p></dd>
</dl>

<p>That’s quite a lot of detail in one header file! But that’s what header
files are for. In the absence of any other documentation, reading a header file should
tell you just about everything you need to know to use a library.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>I’m cheating a bit with this header. For an Arduino library that you intend to share with others,
you wouldn’t normally dictate the pins to use in connecting peripherals. We have the ability
to make this header match up with our physical project, but other users might not have the same
controller or the same free pins. See <a data-type="xref" href="#smallerc-CHP-11-SECT-3.8.3">“Sharing online”</a> for some tips on digging deeper
into shareable library creation. For libraries meant solely for your own projects, though,
you’re allowed a shortcut<a data-type="indexterm" data-primary="header files" data-secondary="for radio control project" data-secondary-sortas="radio control project" data-startref="headers-radio" id="idm45018712126888"/> or two.</p>
</div>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Our radio-control library code"><div class="sect3" id="smallerc-CHP-11-SECT-3.4.3">
<h3>Our radio-control library code</h3>

<p>To complete our library, then, we need to write some code and implement the functions
that were prototyped in our header file. This code is not very complex, but it does
have several novel parts related to enabling and communicating with our radio. You can
type it in yourself or pull up
<a href="https://oreil.ly/pc5v4"><em>SmalleRC.cpp</em></a> in your 
<span class="keep-together">editor</span>:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#</code><code class="cp">include "SmalleRC.h"                                 </code><a class="co" id="co_custom_libraries_CO2-1" href="#callout_custom_libraries_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code class="cp">
</code><code>
</code><code class="n">RH_RF69</code><code> </code><code class="nf">rf69</code><code class="p">(</code><code class="n">RFM69_CS</code><code class="p">,</code><code> </code><code class="n">RFM69_INT</code><code class="p">)</code><code class="p">;</code><code>                    </code><a class="co" id="co_custom_libraries_CO2-2" href="#callout_custom_libraries_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>

</code><code class="kt">char</code><code> </code><code class="nf">rc_start</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>                                     </code><a class="co" id="co_custom_libraries_CO2-3" href="#callout_custom_libraries_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
  </code><code class="n">pinMode</code><code class="p">(</code><code class="n">LED</code><code class="p">,</code><code> </code><code class="n">OUTPUT</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">pinMode</code><code class="p">(</code><code class="n">RFM69_RST</code><code class="p">,</code><code> </code><code class="n">OUTPUT</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">digitalWrite</code><code class="p">(</code><code class="n">RFM69_RST</code><code class="p">,</code><code> </code><code class="n">LOW</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>  </code><code class="c1">// manual reset
</code><code>  </code><code class="n">digitalWrite</code><code class="p">(</code><code class="n">RFM69_RST</code><code class="p">,</code><code> </code><code class="n">HIGH</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">delay</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">digitalWrite</code><code class="p">(</code><code class="n">RFM69_RST</code><code class="p">,</code><code> </code><code class="n">LOW</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">delay</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>  </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="n">rf69</code><code class="p">.</code><code class="n">init</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">rc_INIT_FAILED</code><code class="p">;</code><code>
</code><code>  </code><code class="p">}</code><code>
</code><code>
</code><code>  </code><code class="k">if</code><code> </code><code class="p">(</code><code class="o">!</code><code class="n">rf69</code><code class="p">.</code><code class="n">setFrequency</code><code class="p">(</code><code class="n">RF69_FREQ</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="n">rc_FREQ_FAILED</code><code class="p">;</code><code>
</code><code>  </code><code class="p">}</code><code>
</code><code>
</code><code>  </code><code class="c1">// range from 14-20 for power
</code><code>  </code><code class="c1">// 2nd arg must be true for 69HCW
</code><code>  </code><code class="n">rf69</code><code class="p">.</code><code class="n">setTxPower</code><code class="p">(</code><code class="mi">17</code><code class="p">,</code><code> </code><code class="nb">true</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>  </code><code class="c1">// The encryption key is up to you, but must be
</code><code>  </code><code class="c1">// the same for both the car and the controller
</code><code>  </code><code class="kt">uint8_t</code><code> </code><code class="n">key</code><code class="p">[</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code>                                   </code><a class="co" id="co_custom_libraries_CO2-4" href="#callout_custom_libraries_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
    </code><code class="mh">0x01</code><code class="p">,</code><code> </code><code class="mh">0x02</code><code class="p">,</code><code> </code><code class="mh">0x03</code><code class="p">,</code><code> </code><code class="mh">0x04</code><code class="p">,</code><code> </code><code class="mh">0x05</code><code class="p">,</code><code> </code><code class="mh">0x06</code><code class="p">,</code><code> </code><code class="mh">0x07</code><code class="p">,</code><code> </code><code class="mh">0x08</code><code class="p">,</code><code>
</code><code>    </code><code class="mh">0x01</code><code class="p">,</code><code> </code><code class="mh">0x02</code><code class="p">,</code><code> </code><code class="mh">0x03</code><code class="p">,</code><code> </code><code class="mh">0x04</code><code class="p">,</code><code> </code><code class="mh">0x05</code><code class="p">,</code><code> </code><code class="mh">0x06</code><code class="p">,</code><code> </code><code class="mh">0x07</code><code class="p">,</code><code> </code><code class="mh">0x08</code><code>
</code><code>  </code><code class="p">}</code><code class="p">;</code><code>
</code><code>  </code><code class="n">rf69</code><code class="p">.</code><code class="n">setEncryptionKey</code><code class="p">(</code><code class="n">key</code><code class="p">)</code><code class="p">;</code><code>
</code><code>
</code><code>  </code><code class="n">pinMode</code><code class="p">(</code><code class="n">LED</code><code class="p">,</code><code> </code><code class="n">OUTPUT</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="k">return</code><code> </code><code class="n">rc_INIT_SUCCESS</code><code class="p">;</code><code>
</code><code class="p">}</code><code>
</code><code>
</code><code class="kt">void</code><code> </code><code class="nf">rc_send</code><code class="p">(</code><code class="kt">direction_t</code><code> </code><code class="n">d</code><code class="p">)</code><code> </code><code class="p">{</code><code>                         </code><a class="co" id="co_custom_libraries_CO2-5" href="#callout_custom_libraries_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
  </code><code class="kt">uint8_t</code><code> </code><code class="n">packet</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code> </code><code class="n">d</code><code> </code><code class="p">}</code><code class="p">;</code><code>
</code><code>  </code><code class="n">rf69</code><code class="p">.</code><code class="n">send</code><code class="p">(</code><code class="n">packet</code><code class="p">,</code><code> </code><code class="mi">1</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">rf69</code><code class="p">.</code><code class="n">waitPacketSent</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code><code>
</code><code>
</code><code class="kt">direction_t</code><code> </code><code class="nf">rc_receive</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>                            </code><a class="co" id="co_custom_libraries_CO2-6" href="#callout_custom_libraries_CO2-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
  </code><code class="kt">uint8_t</code><code> </code><code class="n">buf</code><code class="p">[</code><code class="n">RH_RF69_MAX_MESSAGE_LEN</code><code class="p">]</code><code class="p">;</code><code>
</code><code>  </code><code class="kt">uint8_t</code><code> </code><code class="n">len</code><code> </code><code class="o">=</code><code> </code><code class="k">sizeof</code><code class="p">(</code><code class="n">buf</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">rf69</code><code class="p">.</code><code class="n">recv</code><code class="p">(</code><code class="n">buf</code><code class="p">,</code><code> </code><code class="o">&amp;</code><code class="n">len</code><code class="p">)</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>    </code><code class="k">if</code><code> </code><code class="p">(</code><code class="n">len</code><code> </code><code class="o">=</code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>      </code><code class="k">return</code><code> </code><code class="o">-</code><code class="mi">1</code><code class="p">;</code><code>
</code><code>    </code><code class="p">}</code><code>
</code><code>    </code><code class="n">buf</code><code class="p">[</code><code class="n">len</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code><code>
</code><code>    </code><code class="k">return</code><code> </code><code class="p">(</code><code class="kt">direction_t</code><code class="p">)</code><code class="n">buf</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">;</code><code>
</code><code>  </code><code class="p">}</code><code>
</code><code>  </code><code class="k">return</code><code> </code><code class="n">STOP</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_custom_libraries_CO2-1" href="#co_custom_libraries_CO2-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Include our recently built header file with all the pins, directions, and radio
configuration information.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO2-2" href="#co_custom_libraries_CO2-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Create a radio control object similar to the NeoPixel objects in previous projects.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO2-3" href="#co_custom_libraries_CO2-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Initialize the radio. This code is based on the examples included with the library
we installed. See <a data-type="xref" href="#smallerc-CHP-11-SECT-3.8.3">“Sharing online”</a> for a few more details on examples and other library
documentation.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO2-4" href="#co_custom_libraries_CO2-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Part of the radio initialization is setting an encryption key that will make sure
only other radios using the same key can communicate with us. These values are exactly
those from the example. Feel free to change them, just make sure the key is 16 bytes.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO2-5" href="#co_custom_libraries_CO2-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>A simple function to broadcast a direction. The radio library expects a packet of
<code>uint8_t</code> values, so we create a one-element array to match. The library can send longer
messages, of course, but we only need to send this single value.</p></dd>
<dt><a class="co" id="callout_custom_libraries_CO2-6" href="#co_custom_libraries_CO2-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>The receiving function to read any directions coming from the controller. Again,
the radio library can handle longer messages, but we only need the first byte, which should contain our direction. If there’s no message at all, return <code>-1</code> to let the caller know nothing was ready. Otherwise, return the direction we received or <code>STOP</code> as a default.</p></dd>
</dl>

<p>With our custom library in place, we can look at writing the actual projects for the car
and the controller. But we sure whizzed through this code! If you’re curious
about radio communication, I encourage you to
<a href="https://oreil.ly/7YRVZ">play with the examples</a>
from the radio library to get a better feel for what possibilities and<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="creating library" data-startref="custom-libraries-radio-create" id="idm45018711867400"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="creating library" data-startref="car-radio-create" id="idm45018711669864"/><a data-type="indexterm" data-primary="radio control project" data-secondary="creating library" data-startref="radio-create" id="idm45018711668376"/> limits exist.</p>
</div></section>



</div></section>













<section data-type="sect2" data-pdf-bookmark="Updating the Car Project"><div class="sect2" id="smallerc-CHP-11-SECT-3.5">
<h2>Updating the Car Project</h2>

<p>Now we<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="updating car" id="custom-libraries-radio-updatecar"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="updating car" id="car-radio-update"/><a data-type="indexterm" data-primary="radio control project" data-secondary="updating car" id="radio-update"/> need to write the code for the car. (Feel free to review the physical setup
of the car and breakouts in <a data-type="xref" href="#smallerc-CHP-11-SECT-3.2">“Retrofitting Our Car”</a>.) Essentially, we
are going to replace the logic for polling the joystick with a call to check for
data from the radio. We’ll pause for a few milliseconds to avoid starting
and stopping the motors too quickly. Otherwise, we’ll run a pretty tight
loop so that the car feels responsive to our remote controller.</p>

<p>I based this version
(<a href="https://oreil.ly/Dk0JC"><em>car3</em></a>) on the <em>car2</em> project, which
had the separate <em>pins.h</em> and <em>drive.ino</em> files. We no longer need the pins for the joystick
in this project, so the header file is a bit shorter:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#ifndef PINS_H</code>
<code class="cp">#define PINS_H</code>

<code class="cp">#define AIN1 9</code>
<code class="cp">#define AIN2 8</code>
<code class="cp">#define BIN1 6</code>
<code class="cp">#define BIN2 7</code>

<code class="cp">#endif </code><code class="cm">/* PINS_H */</code><code class="cp"/></pre>

<p>The driving functions are completely unchanged so I’ll leave those out, but
you can review the code (<a data-type="xref" href="#smallerc-CHP-11-SECT-2.1">“Code (.ino) Files”</a>) if you want. The code for the main
<a href="https://oreil.ly/JcLJl"><em>car3.ino</em></a>
file should feel familiar, but obviously we need to include the header file of
our new radio library:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#include "pins.h"</code>
<code class="cp">#include "SmalleRC.h"</code>

<code class="kt">void</code> <code class="nf">setup</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">Serial</code><code class="p">.</code><code class="n">begin</code><code class="p">(</code><code class="mi">115200</code><code class="p">);</code>
  <code class="c1">// Send output to the motor pins</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">AIN1</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">AIN2</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">BIN1</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">BIN2</code><code class="p">,</code> <code class="n">OUTPUT</code><code class="p">);</code>

  <code class="k">if</code> <code class="p">(</code><code class="n">rc_start</code><code class="p">()</code> <code class="o">!=</code> <code class="n">rc_INIT_SUCCESS</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">Serial</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"Failed to initialize radio."</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">loop</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">direction_t</code> <code class="n">dir</code> <code class="o">=</code> <code class="n">rc_receive</code><code class="p">();</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">dir</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code> <code class="c1">// Driving!</code>
    <code class="k">switch</code> <code class="p">(</code><code class="n">dir</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">case</code> <code class="nl">rc_FORWARD</code><code class="p">:</code>
        <code class="n">forward</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="k">case</code> <code class="nl">rc_BACKWARD</code><code class="p">:</code>
        <code class="n">backward</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="k">case</code> <code class="nl">rc_LEFT</code><code class="p">:</code>
        <code class="n">left</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
      <code class="k">case</code> <code class="nl">rc_RIGHT</code><code class="p">:</code>
        <code class="n">right</code><code class="p">();</code>
        <code class="k">break</code><code class="p">;</code>
    <code class="p">}</code>
    <code class="n">delay</code><code class="p">(</code><code class="mi">20</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
    <code class="c1">// Stopping, or eventually we could handle errors, too</code>
    <code class="n">allstop</code><code class="p">();</code>
  <code class="p">}</code>
<code class="p">}</code></pre>

<p>Notice that I’m using the new navigation constants (like <code>rc_LEFT</code>)
defined in the <em>SmalleRC.h</em> file. But that’s really all the code
we need now to drive our car! This is one of the
many benefits from separating out chunks of common code. By building on that
shared code, you can more quickly create some very interesting projects.</p>

<p>There’s no good way to test this new <em>car3</em> project just yet, but go ahead
and upload it to your microcontroller. If nothing else, you can use the Serial Monitor
tool to ensure that there were no errors in starting up the radio to receive. I went
with the “no news is good news” approach to errors in the <code>setup()</code>
function, but feel free to alter that a bit to produce a success<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="updating car" data-startref="custom-libraries-radio-updatecar" id="idm45018711933560"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="updating car" data-startref="car-radio-update" id="idm45018711932008"/><a data-type="indexterm" data-primary="radio control project" data-secondary="updating car" data-startref="radio-update" id="idm45018711930520"/> message if you like.</p>
<div data-type="tip"><h6>Tip</h6>
<p>Now that the Arduino IDE knows about our <em>SmalleRC</em> library, you can actually edit
the source files of <a data-type="indexterm" data-primary="custom libraries" data-secondary="editing source files" id="idm45018711927464"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="editing source files" id="idm45018711926488"/><a data-type="indexterm" data-primary="editing" data-secondary="library source files" id="idm45018712051144"/>that library in place and then reverify or reupload the project.
If you do have some trouble starting the radio, for example, add some debugging
calls to <code>Serial.println()</code> in <em>SmalleRC.cpp</em>. Once you have the problem isolated
and solved, you can remove the debugging statements and upload once more.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Getting It Under Control"><div class="sect2" id="smallerc-CHP-11-SECT-3.6">
<h2>Getting It Under Control</h2>

<p>Next up<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="controller setup" id="custom-libraries-radio-controller-setup"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="controller setup" id="car-radio-controller-setup"/><a data-type="indexterm" data-primary="radio control project" data-secondary="controller setup" id="radio-controller-setup"/><a data-type="indexterm" data-primary="controller setup for radio-controlled car" id="controller-setup2"/> is getting the controller programmed. (Again, look back at <a data-type="xref" href="#smallerc-CHP-11-SECT-3.3">“Creating a Controller”</a>
if you still need to build the physical remote control.) Here we take the joystick
polling and instead of sending the results to the motors, we broadcast any directional
information over our radio. This is a pretty small project thanks to the library, so I
left it in a single
<a href="https://oreil.ly/rSPTh"><em>ch11/controller/controller.ino</em></a> file:</p>

<pre data-type="programlisting" data-code-language="c" class="pagebreak-before less_space"><code class="cp">#include "SmalleRC.h"</code>

<code class="cp">#define LEFT_BTN  9</code>
<code class="cp">#define RIGHT_BTN 7</code>
<code class="cp">#define FWD_BTN   8</code>
<code class="cp">#define BKWD_BTN  6</code>

<code class="kt">void</code> <code class="nf">setup</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">Serial</code><code class="p">.</code><code class="n">begin</code><code class="p">(</code><code class="mi">115200</code><code class="p">);</code>
  <code class="c1">// Accept input from the joystick pins</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">LEFT_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">RIGHT_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">FWD_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>
  <code class="n">pinMode</code><code class="p">(</code><code class="n">BKWD_BTN</code><code class="p">,</code> <code class="n">INPUT_PULLUP</code><code class="p">);</code>

  <code class="k">if</code> <code class="p">(</code><code class="n">rc_start</code><code class="p">()</code> <code class="o">!=</code> <code class="n">rc_INIT_SUCCESS</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">Serial</code><code class="p">.</code><code class="n">println</code><code class="p">(</code><code class="s">"Failed to initialize radio."</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="kt">direction_t</code> <code class="nf">readDirection</code><code class="p">()</code> <code class="p">{</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">FWD_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">rc_FORWARD</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">BKWD_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">rc_BACKWARD</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">LEFT_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">rc_LEFT</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="k">if</code> <code class="p">(</code><code class="n">digitalRead</code><code class="p">(</code><code class="n">RIGHT_BTN</code><code class="p">)</code> <code class="o">==</code> <code class="n">LOW</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="n">rc_RIGHT</code><code class="p">;</code>
  <code class="p">}</code>
  <code class="c1">// No buttons were pressed, so return STOP</code>
  <code class="k">return</code> <code class="n">rc_STOP</code><code class="p">;</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">loop</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">direction_t</code> <code class="n">dir</code> <code class="o">=</code> <code class="n">readDirection</code><code class="p">();</code>
  <code class="n">rc_send</code><code class="p">(</code><code class="n">dir</code><code class="p">);</code>
  <code class="n">delay</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>We could have put the logic of the <code>readDirection()</code> function right inside our
<code>loop()</code> function, but I like how concise <code>loop()</code> is with this small abstraction.</p>

<p>Try verifying this new project and if you hit any snags, add a few more
<code>Serial.println()</code> statements. And remember, you can also add those to your library code if<a data-type="indexterm" data-primary="custom libraries" data-secondary="radio control example" data-tertiary="controller setup" data-startref="custom-libraries-radio-controller-setup" id="idm45018712035304"/><a data-type="indexterm" data-primary="car example project" data-secondary="radio control" data-tertiary="controller setup" data-startref="car-radio-controller-setup" id="idm45018711282312"/><a data-type="indexterm" data-primary="radio control project" data-secondary="controller setup" data-startref="radio-controller-setup" id="idm45018711280808"/><a data-type="indexterm" data-primary="controller setup for radio-controlled car" data-startref="controller-setup2" id="idm45018711279592"/> needed.</p>
<div data-type="tip"><h6>Tip</h6>
<p>For projects <a data-type="indexterm" data-primary="debugging" data-secondary="libraries and wiring" id="idm45018711277256"/><a data-type="indexterm" data-primary="wiring, debugging" id="idm45018711276248"/><a data-type="indexterm" data-primary="libraries" data-secondary="debugging" id="idm45018711275576"/>like this, where so much work is done in libraries
(not just our custom one, but also libraries like <code>RF_RH69</code>)
<code>println()</code> calls may not help with every problem. Bugs in downloaded libraries
do happen, but they’re pretty rare.
I find many problems are caused by me getting some of the wiring wrong.
So if things still aren’t working, try double-checking your connections
between the microcontroller and the various <a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="radio control example" data-startref="libraries-custom-radio" id="idm45018711273240"/><a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="car example project" data-tertiary="radio control setup" data-startref="ardmicro-car-radio" id="idm45018711271720"/>peripherals.</p>
</div>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Go Driving!"><div class="sect2" id="smallerc-CHP-11-SECT-3.7">
<h2>Go Driving!</h2>

<p>No code. No diagrams. No instructions. Just another point in this chapter where I
wholly encourage you to go play. :) Try powering up both projects and see what happens
when you move the joystick. There are definitely things that could go wrong! If the
wiring isn’t quite right, for example, the car might move, but not in the direction
you meant. (I accidentally swapped the right-side motor input pins when moving the
project to a full-size breadboard, for example. The right wheel turned, but in the
wrong direction.) Or if we have the wrong pins connected to the joystick, we might
not send any signal at all.</p>

<p>If the car doesn’t budge, it’s time yet again to break out your debugging skills.
You can have both projects connected to your computer at the same time, by the way. They will
simply be on different serial ports. (Remember, you can set which port you use for your
microcontroller through the Tools menu in the Arduino IDE.)
You can use <code>Serial.println()</code> statements to
make sure your inputs, sends, receives, and drives are all doing what you
expect them to do. Just watch out for success! When you do get things working, it’s
surprisingly easy to drive your car right off the desk and leave a string of
electronics dangling from your USB cable. Or, you know, <a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="creating custom" data-startref="ardIDE-library-customcreate" id="idm45018711266312"/><a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="creating custom" data-startref="libraries-arduino-customcreate" id="idm45018711264824"/>so I’m told.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Documentation and Distribution"><div class="sect2" id="smallerc-CHP-11-SECT-3.8">
<h2>Documentation and Distribution</h2>

<p>Once <a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="documentation" id="ardIDE-library-document"/><a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="documentation" id="libraries-arduino-document"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="documentation" id="libraries-custom-document"/><a data-type="indexterm" data-primary="custom libraries" data-secondary="documentation" id="custom-libraries-document"/><a data-type="indexterm" data-primary="documentation" id="documentation"/>your library is working and you’ve had enough fun zipping around your
room, it’s time to think about adding a little documentation to your project.
Documentation is great. Not just for other programmers who might use your library,
either. If you step away from a project even just for a few days, any documentation
you wrote can be surprisingly useful for helping you get your own mind back up to
speed.</p>










<section data-type="sect3" data-pdf-bookmark="Keywords"><div class="sect3" id="smallerc-CHP-11-SECT-3.8.1">
<h3>Keywords</h3>

<p>One very<a data-type="indexterm" data-primary="keywords" id="keyword-document"/> simple piece of documentation that you can add for use with the Arduino IDE is
a single text file called <em>keywords.txt</em>. For a custom library, it should contain two
columns, separated by a tab. The first column contains functions, constants, and
data types defined in your library. The second column should contain one entry from
<a data-type="xref" href="#smallerc-CHP-11-TAB-keywords-txt">Table 11-1</a> indicating the category of the name in the first column.</p>
<table id="smallerc-CHP-11-TAB-keywords-txt">
<caption><span class="label">Table 11-1. </span>Keyword categories for documenting Arduino libraries</caption>
<thead>
<tr>
<th>Category Name</th>
<th>Purpose</th>
<th>Appearance</th>
</tr>
</thead>
<tbody>
<tr>
<td><p>KEYWORD1</p></td>
<td><p>data types</p></td>
<td><p>orange, bold</p></td>
</tr>
<tr>
<td><p>KEYWORD2</p></td>
<td><p>functions</p></td>
<td><p>orange, plain</p></td>
</tr>
<tr>
<td><p>LITERAL1</p></td>
<td><p>constants</p></td>
<td><p>blue, plain</p></td>
</tr>
</tbody>
</table>

<p>While limited, these few categories can still help programmers who rely on the IDE
cues for things like whether or not they spelled a function name correctly.</p>

<p>For our library, then, we could create the following entries (again, separated by a tab)
in our own <a href="https://oreil.ly/o3KjH"><em>keywords.txt</em></a> file:</p>

<pre data-type="programlisting">rc_INIT_SUCCESS LITERAL1
rc_INIT_FAILED  LITERAL1
rc_FREQ_FAILED  LITERAL1

direction_t KEYWORD1

rc_STOP LITERAL1
rc_LEFT LITERAL1
rc_RIGHT    LITERAL1
rc_FORWARD  LITERAL1
rc_BACKWARD LITERAL1

rc_start    KEYWORD2
rc_send KEYWORD2
rc_receive  KEYWORD2</pre>

<p>Basically, that list is everything we defined in our <em>SmalleRC.h</em> file minus the few
constants that were used only by the radio library. If you restart your IDE at this point,
the functions and other names listed in the file will share the same syntax highlighting
that the core language uses! Very cool.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Be sure to use real tab characters to separate the columns in <em>keywords.txt</em>. Spaces
will not work. Many editors (like VS Code, for example) have a reasonable setting that
turns all tabs into the appropriate number of spaces when the file is saved. There are
many reasons that quiet change can be useful in source files, but we don’t want
it here.</p>

<p>If you can’t temporarily disable this feature in your editor of choice, <em>keywords.txt</em>
really is just a text file. You can create or edit it using any text editor, including
very simple ones like Notepad in Windows 10 or TextEdit <a data-type="indexterm" data-primary="keywords" data-startref="keyword-document" id="idm45018711232056"/>in macOS.</p>
</div>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Including examples"><div class="sect3" id="smallerc-CHP-11-SECT-3.8.2">
<h3>Including examples</h3>

<p>Including a <a data-type="indexterm" data-primary="example projects as documentation" id="idm45018711228776"/>few example projects with your library is another great addition that
doesn’t require too much effort. You simply create an <em>examples</em> folder in
the folder with your library code and <em>keywords.txt</em> file. Inside <em>examples</em>, then,
you can place a few project folders. (Use the entire folder, not just the <em>.ino</em> file
inside.)</p>

<p>Example projects should be short and sweet. Don’t include unnecessary features
that don’t make use of the library if at all possible. You want a new user to
see the important parts of your library and how they fit within a sketch. If your
library is fairly rich, don’t be afraid of providing several smaller examples
that each focus on a particular aspect of the library.</p>

<p>Of course, you will find the other end of that “smaller, focused” spectrum
in the wild. Sometimes a single example contains a demonstration of every single feature
in a library. While these expansive examples do highlight the use of a library, they can
make it more difficult for an outsider to extract details. If you’re only trying to learn about one or two of the functions in a library, big examples can be overwhelming.</p>

<p>But any example is better than no examples! If you only have the energy for the single, comprehensive approach, include it. If you host it somewhere public like GitHub, you might even invite other users to contribute some focused examples from their own <a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="documentation" data-startref="ardIDE-library-document" id="idm45018711223800"/><a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="documentation" data-startref="libraries-arduino-document" id="idm45018711222280"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="documentation" data-startref="libraries-custom-document" id="idm45018711220824"/><a data-type="indexterm" data-primary="custom libraries" data-secondary="documentation" data-startref="custom-libraries-document" id="idm45018711219320"/><a data-type="indexterm" data-primary="documentation" data-startref="documentation" id="idm45018711218088"/>projects.</p>
</div></section>













<section data-type="sect3" data-pdf-bookmark="Sharing online"><div class="sect3" id="smallerc-CHP-11-SECT-3.8.3">
<h3>Sharing online</h3>

<p>If you <a data-type="indexterm" data-primary="Arduino IDE" data-secondary="libraries" data-tertiary="sharing online" id="idm45018711215096"/><a data-type="indexterm" data-primary="libraries" data-secondary="Arduino" data-tertiary="sharing online" id="idm45018711213816"/><a data-type="indexterm" data-primary="libraries" data-secondary="custom" data-tertiary="sharing online" id="idm45018711212600"/><a data-type="indexterm" data-primary="custom libraries" data-secondary="sharing online" id="idm45018711211384"/><a data-type="indexterm" data-primary="sharing custom libraries" id="idm45018711210440"/><a data-type="indexterm" data-primary="publishing custom libraries" id="idm45018711209800"/>do get serious about sharing your code, you’ll want to check out the
official <a href="https://oreil.ly/hB0rX">Library Guide</a> online, as well
as the excellent <a href="https://oreil.ly/uifGf">Library
Specification</a> document. There are a few more things you can add to your library folder
if you want it to feel polished. You can even get your library to work with the Library
Manager in the IDE. A quick heads-up, though: these docs (reasonably) use <span class="keep-together">C++</span>. <span class="keep-together">C++</span> has many more facilities for sharing the
appropriate parts of your code while hiding the implementation details. There are
definitely bits of syntax that will be new to you, but hopefully nothing too overwhelming.</p>

<p>As a first step toward publishing your library, check out the
<a href="https://oreil.ly/3y4IT">FAQ</a> direct from the Arduino team.</p>
</div></section>



</div></section>





</div></section>













<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="Next Steps"><div class="sect1" id="smallerc-CHP-11-SECT-4">
<h1>Next Steps</h1>

<p>Even if you never publish a library, we have seen how to manage larger projects with
several tricks including preprocessor macros, type aliasing, and using multiple tabs
in the Arduino IDE. We also covered creating simple libraries that you can manually
install on your system to share between your own projects.</p>

<p>It’s useful to remember that the tab and library stuff is peculiar to
the Arduino IDE. Other IDEs or environments may have their own
quirks, but you can almost always find a way to use multiple files when needed.
The main goal is to keep you productive with whatever tools you choose.</p>

<p>I mentioned that you might want to know a little <span class="keep-together">C++</span> if you publish any libraries.
<span class="keep-together">C++</span> in general is an excellent topic to explore after this book.
In the next chapter, we’ll look at a more advanced project as a stepping-stone
out into the wider world. I’ll also suggest a few other topics worth considering
as you continue to expand your C and Arduino skills.</p>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm45018712401128"><sup><a href="ch11.xhtml#idm45018712401128-marker">1</a></sup> There are certainly <a href="https://oreil.ly/AEvxE">fancier options</a> available if you are so inclined or want to communicate over longer distances.</p><p data-type="footnote" id="idm45018712345416"><sup><a href="ch11.xhtml#idm45018712345416-marker">2</a></sup> <em>Forked</em> would be a better verb than <em>written</em>. The Adafruit library is based on the <a href="https://oreil.ly/nP82M">AirSpayce RadioHead</a> library written by Mike McCauley.</p></div></div></section></div></body></html>