<html><head></head><body><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 10. Faster Code"><div class="chapter" id="smallerc-CHP-10">
<h1><span class="label">Chapter 10. </span>Faster Code</h1>


<p>I mentioned at the very beginning of <a data-type="xref" href="ch01.xhtml#smallerc-CHP-1">Chapter 1</a>
that C was designed for machines with limited resources—at least
by today’s standards. Microcontrollers have many of those same limitations,
making C a pretty natural fit as a development language. Indeed, if you want to get
the maximum possible performance out of a tiny chip, C’s ability to work
directly with memory addresses, as we saw in <a data-type="xref" href="ch06.xhtml#smallerc-CHP-6-SECT-1">“Addresses in C”</a>, is unparalleled, if tedious.<sup><a data-type="noteref" id="idm45018716293016-marker" href="ch10.xhtml#idm45018716293016">1</a></sup></p>

<p>I’m happy to say that even without diving into the depths of datasheets (seriously technical
specifications produced by component and microcontroller manufacturers), you can employ
several straightforward tricks to speed up your code. But do remember that sometimes
good enough is, well, good enough! Try getting your code going with the
patterns you know first. Does your program run? Does it do what you need? If so,
the interesting options I highlight in this chapter, such as using integers rather
than floating point numbers or unrolling loops, are just that: interesting.
They are not really “better” and certainly not necessary. Usually. The
Arduino and its cousins are definitely more limited than desktops. Sometimes
your program won’t run or doesn’t quite do what you need. In those
instances, consider bringing some of the following optimizations to bear.</p>






<section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="The Setup"><div class="sect1" id="smallerc-CHP-10-SECT-1">
<h1>The Setup</h1>

<p>Rather<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="setup for" id="ardmicro-optimize-setup"/><a data-type="indexterm" data-primary="optimization" data-secondary="setup for" id="optimize-setup"/> than toss another slew of new gadgets and configurations and wiring diagrams
at you, I’m going to focus on a hardware setup similar to our first Arduino projects back
in <a data-type="xref" href="ch08.xhtml#smallerc-CHP-8">Chapter 8</a>. We’ll use one NeoPixel strip.
<a data-type="xref" href="#smallerc-CHP-10-FIG-optimize-led">Figure 10-1</a> shows the usual wiring diagram and my Metro Mini wired
(and powered) up.</p>

<figure><div id="smallerc-CHP-10-FIG-optimize-led" class="figure">
<img src="Images/smac_1001.png" alt="smac 1001" width="4230" height="2000"/>
<h6><span class="label">Figure 10-1. </span>Our simple LED setup</h6>
</div></figure>

<p>Next, we’ll steal the “breathing” logic from <a data-type="xref" href="ch09.xhtml#smallerC-CHP-9-SECT-1.4">“Trying Out the Arduino ‘Stuff’”</a> and apply
it to each pixel in the strip. Rather than start with random colors, we’ll simply
assign some nice rainbowy ones. Feel free to tweak the colors, by the way. Pick
a palette you will enjoy staring at; we’ll be using this sketch as the basis for
every optimization in the chapter.</p>

<p>Pull up
<a href="https://oreil.ly/UHE04"><em>ch10/optimize/optimize.ino</em></a>
and try it out on your own setup. Be sure
to adjust the <code>LED_PIN</code> and <code>LED_COUNT</code> values if needed.</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#include &lt;Adafruit_NeoPixel.h&gt;</code>

<code class="cp">#define LED_PIN     4</code>
<code class="cp">#define LED_COUNT   8</code>
<code class="cp">#define RATE     5000</code>
<code class="cp">#define PI_2 6.283185</code>

<code class="n">Adafruit_NeoPixel</code> <code class="nf">stick</code><code class="p">(</code><code class="n">LED_COUNT</code><code class="p">,</code> <code class="n">LED_PIN</code><code class="p">,</code> <code class="n">NEO_GRB</code><code class="p">);</code>
<code class="kt">uint32_t</code> <code class="n">colors</code><code class="p">[]</code> <code class="o">=</code> <code class="p">{</code>
  <code class="mh">0xFF0000</code><code class="p">,</code> <code class="mh">0x00FF00</code><code class="p">,</code> <code class="mh">0x0000FF</code><code class="p">,</code> <code class="mh">0x3377FF</code><code class="p">,</code>
  <code class="mh">0x00FFFF</code><code class="p">,</code> <code class="mh">0xFF00FF</code><code class="p">,</code> <code class="mh">0xFFFF00</code><code class="p">,</code> <code class="mh">0xFF7733</code>
<code class="p">};</code>

<code class="kt">void</code> <code class="nf">setup</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">Serial</code><code class="p">.</code><code class="n">begin</code><code class="p">(</code><code class="mi">115200</code><code class="p">);</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">begin</code><code class="p">();</code>             <code class="c1">// Initialize our LEDs</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">setBrightness</code><code class="p">(</code><code class="mi">128</code><code class="p">);</code>  <code class="c1">// Set a comfortable brightness</code>
  <code class="c1">// Show our colors for a few seconds before animating</code>
  <code class="k">for</code> <code class="p">(</code><code class="n">byte</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">p</code> <code class="o">&lt;</code> <code class="n">LED_COUNT</code><code class="p">;</code> <code class="n">p</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]);</code>
  <code class="p">}</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">show</code><code class="p">();</code>
  <code class="n">delay</code><code class="p">(</code><code class="n">RATE</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">loop</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">double</code> <code class="n">ms_in_radians</code> <code class="o">=</code> <code class="p">(</code><code class="n">millis</code><code class="p">()</code> <code class="o">%</code> <code class="n">RATE</code><code class="p">)</code> <code class="o">*</code> <code class="n">PI_2</code> <code class="o">/</code> <code class="n">RATE</code><code class="p">;</code>
  <code class="kt">double</code> <code class="n">breath</code> <code class="o">=</code> <code class="p">(</code><code class="n">sin</code><code class="p">(</code><code class="n">ms_in_radians</code><code class="p">)</code> <code class="o">+</code> <code class="mf">1.0</code><code class="p">)</code> <code class="o">/</code> <code class="mf">2.0</code><code class="p">;</code>
  <code class="k">for</code> <code class="p">(</code><code class="n">byte</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">p</code> <code class="o">&lt;</code> <code class="n">LED_COUNT</code><code class="p">;</code> <code class="n">p</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">byte</code> <code class="n">red</code>   <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code> <code class="o">&amp;</code> <code class="mh">0xFF0000</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">16</code><code class="p">;</code>
    <code class="n">byte</code> <code class="n">green</code> <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code> <code class="o">&amp;</code> <code class="mh">0x00FF00</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
    <code class="n">byte</code> <code class="n">blue</code>  <code class="o">=</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code> <code class="o">&amp;</code> <code class="mh">0x0000FF</code><code class="p">;</code>
    <code class="n">red</code> <code class="o">=</code> <code class="p">(</code><code class="n">byte</code><code class="p">)(</code><code class="n">red</code> <code class="o">*</code> <code class="n">breath</code><code class="p">);</code>
    <code class="n">green</code> <code class="o">=</code> <code class="p">(</code><code class="n">byte</code><code class="p">)(</code><code class="n">green</code> <code class="o">*</code> <code class="n">breath</code><code class="p">);</code>
    <code class="n">blue</code> <code class="o">=</code> <code class="p">(</code><code class="n">byte</code><code class="p">)(</code><code class="n">blue</code> <code class="o">*</code> <code class="n">breath</code><code class="p">);</code>
    <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">red</code><code class="p">,</code> <code class="n">green</code><code class="p">,</code> <code class="n">blue</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">show</code><code class="p">();</code>
  <code class="n">delay</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>With this minimal example in place, we can look at some popular techniques for
gaining performance. Many of these techniques are squarely in the trade-off realm.
Many take up a little extra storage in flash memory or in SRAM in return for speeding
up the work you have to do in the <code>loop()</code> function. Some, though, are trade-offs
involving your time and energy as a programmer. But again, if your program is
already working the way you want, there’s not really anything overly
superior in the alterations that<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="setup for" data-startref="ardmicro-optimize-setup" id="idm45018716271608"/><a data-type="indexterm" data-primary="optimization" data-secondary="setup for" data-startref="optimize-setup" id="idm45018716270216"/> follow. :)</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Floating-Point Versus Integer Math"><div class="sect1" id="smallerc-CHP-10-SECT-2">
<h1>Floating-Point Versus Integer Math</h1>

<p>A lot<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="floating-point math" id="ardmicro-optimize-float"/><a data-type="indexterm" data-primary="optimization" data-secondary="floating-point math" data-tertiary="processing requirements" id="optimize-float"/><a data-type="indexterm" data-primary="floating-point math" data-secondary="processing requirements" id="float-processing"/> of computer hardware press these days discusses the ever more powerful GPUs
(graphics processing units, impressive chips devoted to displaying and manipulating graphics)
available from various venders. But not so long ago, you could also talk about separate FPUs,
or floating-point units (impressive chips devoted to performing—and speeding
up—floating-point calculations).<sup><a data-type="noteref" id="idm45018716049464-marker" href="ch10.xhtml#idm45018716049464">2</a></sup> Floating-point math takes power, and it took a while
for computers to get generally powerful enough that such niceties could be
integrated.</p>

<p>Happily, our computers have really grown in power (while shrinking in size) and Arduino projects
do have access to good floating-point support and fancier things that use floating-point
math like trigonometric functions. But doing that math still takes more horsepower
than doing purely integer math. If you hang around the
<a href="https://oreil.ly/xT1E6">Arduino forums</a>, you’ll see
anecdotes about floating-point math taking twice (or more!) the time that comparable
calculations take with integer operands.</p>
<div data-type="note" epub:type="note"><h6>Note</h6>
<p>It’s worth pointing out that on <a data-type="indexterm" data-primary="float (variable type)" id="idm45018716045288"/><a data-type="indexterm" data-primary="double (variable type)" id="idm45018716044584"/><a data-type="indexterm" data-primary="variables" data-secondary="types" data-tertiary="float" id="idm45018716043912"/><a data-type="indexterm" data-primary="variables" data-secondary="types" data-tertiary="double" id="idm45018716042696"/><a data-type="indexterm" data-primary="types (variables)" data-secondary="float" id="idm45018716041480"/><a data-type="indexterm" data-primary="types (variables)" data-secondary="double" id="idm45018716040536"/>microcontrollers, <code>float</code> and <code>double</code>
are not always 4- and 8-byte types like they usually are on desktops. On the Metro Mini
(with a 16MHz ATmega328P chip), for example, both types are 4 bytes. It’s unlikely
this fact will cause much trouble, but on the off chance you need really high-precision
floating-point numbers, you may need to look for a library to help<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="floating-point math" data-startref="ardmicro-optimize-float" id="idm45018716038248"/><a data-type="indexterm" data-primary="optimization" data-secondary="floating-point math" data-tertiary="processing requirements" data-startref="optimize-float" id="idm45018716036760"/><a data-type="indexterm" data-primary="floating-point math" data-secondary="processing requirements" data-startref="float-processing" id="idm45018716035272"/> out.</p>
</div>








<section data-type="sect2" data-pdf-bookmark="Floating-Point Math Alternatives"><div class="sect2" id="smallerc-CHP-10-SECT-2.1">
<h2>Floating-Point Math Alternatives</h2>

<p>Many times,<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="integer math" id="ardmicro-optimize-integer"/><a data-type="indexterm" data-primary="optimization" data-secondary="floating-point math" data-tertiary="alternatives" id="optimize-float-alternative"/><a data-type="indexterm" data-primary="floating-point math" data-secondary="alternatives" id="float-alternative"/><a data-type="indexterm" data-primary="integer math" data-secondary="as floating-point alternative" data-secondary-sortas="floating-point alternative" id="integer-float-alt"/> programmers use floating-point numbers without really considering the costs.
Decimal numbers and fractions are everywhere around us: gas gauges, gas prices, tax rates,
tip percentages, and on and on and on. It can make sense to use them in some cases, especially
when outputting information meant to be read by humans. (For example, we converted the raw voltage
readings of our TMP36 sensor from <a data-type="xref" href="ch09.xhtml#smallerc-CHP-9-SECT-2.4">“Segmented Displays”</a> to floating-point degrees.)</p>

<p>But if we are just doing some internal work, and not showing those results to users,
sometimes we can get the same results with integers. Consider these two calculations:</p>

<pre data-type="programlisting" data-code-language="c"><code class="kt">int</code> <code class="n">dozen</code> <code class="o">=</code> <code class="mi">12</code><code class="p">;</code>
<code class="kt">int</code> <code class="n">six</code> <code class="o">=</code> <code class="n">dozen</code> <code class="o">*</code> <code class="mf">0.5</code><code class="p">;</code>
<code class="kt">int</code> <code class="n">half_a_dozen</code> <code class="o">=</code> <code class="n">dozen</code> <code class="o">/</code> <code class="mi">2</code><code class="p">;</code></pre>

<p>Both <code>six</code> and <code>half_a_dozen</code> will contain the <code>int</code> value 6, but multiplying by 0.5 is more expensive. This example is obviously contrived, but only slightly. Let’s look at our <code>breath</code> calculation and think about what, exactly, we are trying to do:</p>

<pre data-type="programlisting" data-code-language="c">  <code class="kt">double</code> <code class="n">ms_in_radians</code> <code class="o">=</code> <code class="p">(</code><code class="n">millis</code><code class="p">()</code> <code class="o">%</code> <code class="n">RATE</code><code class="p">)</code> <code class="o">*</code> <code class="n">PI_2</code> <code class="o">/</code> <code class="n">RATE</code><code class="p">;</code>
  <code class="kt">double</code> <code class="n">breath</code> <code class="o">=</code> <code class="p">(</code><code class="n">sin</code><code class="p">(</code><code class="n">ms_in_radians</code><code class="p">)</code> <code class="o">+</code> <code class="mf">1.0</code><code class="p">)</code> <code class="o">/</code> <code class="mf">2.0</code><code class="p">;</code>
  <code class="c1">// ...</code>
  <code class="n">red</code> <code class="o">=</code> <code class="p">(</code><code class="n">byte</code><code class="p">)(</code><code class="n">red</code> <code class="o">*</code> <code class="n">breath</code><code class="p">);</code></pre>

<p>We are taking an ever-increasing count and turning it into a value between 0.0 and 1.0.
We then multiply that value to give us a “portion” of our various colors.
The net result, though, is still a <code>byte</code> value. We never use 140.7 units of red, we only use 140. What we’re really trying to do is convert a value from the range (0 to <code>RATE</code>) to a value in the range (0 to 255) along a wave-like curve.</p>

<p>It just so happens that this task is very common for LED applications—it makes for
nice fading animations, as we’ve seen. There is a very spiffy
<code>sine8()</code> function in the NeoPixel library that approximates the sine calculation with <code>uint8_t</code> values<sup><a data-type="noteref" id="idm45018715776888-marker" href="ch10.xhtml#idm45018715776888">3</a></sup> as both
inputs and outputs. <code>sine8()</code> treats <a data-type="indexterm" data-primary="sine8() function" id="idm45018715946296"/><a data-type="indexterm" data-primary="functions" data-secondary="sine8()" id="idm45018715945560"/>the input range of (0 to 255) as if it were the
classic radian range of (0 to 2π). In turn, it outputs values between 0 and 255
as though it were the classic (–1 to 1) range of the sine wave.</p>

<p>That might sound too mathy, but the upshot is that we can get our brightness animation
by constraining our (increasing) milliseconds to the range (0 to 255) and using the
<code>sine8()</code> function to get a cycling value between 0 and 255. We can then treat
<code>breath / 255</code> as a fraction with all integer parts. That allows us to apply our
<code>half_a_dozen</code> trick. Rather than multiply by a floating-point value between 0.0 and 1.0,
we multiply by <code>breath</code> and then divide by 255:</p>

<pre data-type="programlisting" data-code-language="c">  <code class="kt">uint8_t</code> <code class="n">ms</code> <code class="o">=</code> <code class="p">(</code><code class="n">millis</code><code class="p">()</code> <code class="o">%</code> <code class="n">RATE</code><code class="p">)</code> <code class="o">/</code> <code class="mi">20</code><code class="p">;</code> <code class="c1">// close enough :)</code>
  <code class="kt">uint8_t</code> <code class="n">breath</code> <code class="o">=</code> <code class="n">stick</code><code class="p">.</code><code class="n">sine8</code><code class="p">(</code><code class="n">ms</code><code class="p">);</code>
  <code class="c1">// ...</code>
  <code class="n">red</code> <code class="o">=</code> <code class="n">red</code> <code class="o">*</code> <code class="n">breath</code> <code class="o">/</code> <code class="mi">255</code><code class="p">;</code></pre>

<p>Slick! But be careful not to use parentheses around our “fraction”
<code>breath / 255</code>. While it might read nicer and highlight the proportional value
we’re after, in integer math, dividing a smaller
number (something between 0 and 255) by a larger number (always 255) will just
give us 0, except for the very last case of 255 / 255, which does <a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="integer math" data-startref="ardmicro-optimize-integer" id="idm45018715764296"/><a data-type="indexterm" data-primary="optimization" data-secondary="floating-point math" data-tertiary="alternatives" data-startref="optimize-float-alternative" id="idm45018715762968"/><a data-type="indexterm" data-primary="floating-point math" data-secondary="alternatives" data-startref="float-alternative" id="idm45018715761512"/><a data-type="indexterm" data-primary="integer math" data-secondary="as floating-point alternative" data-secondary-sortas="floating-point alternative" data-startref="integer-float-alt" id="idm45018715760296"/>result in 1.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Integer Math Versus No Math"><div class="sect2" id="smallerc-CHP-10-SECT-2.2">
<h2>Integer Math Versus No Math</h2>

<p>You know<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="arrays" id="ardmicro-optimize-array"/><a data-type="indexterm" data-primary="optimization" data-secondary="with arrays" data-secondary-sortas="arrays" id="optimize-array"/><a data-type="indexterm" data-primary="arrays" data-secondary="optimization with" id="array-optimization"/><a data-type="indexterm" data-primary="integer math" data-secondary="avoiding with arrays" id="integer-array"/> what’s better than integer math? No math at all! Sometimes a little
planning can make a big difference. Look at how we use the <code>colors</code> array. We use
the actual, full 32-bit values only once in <code>setup()</code>. Inside <code>loop()</code>, though,
we break up those colors into their respective red, green, and blue parts. And
we do that every 10 milliseconds. Yikes! So rather than store single 32-bit values,
why not store individual bytes from the get-go? We could use a two-dimensional <code>byte</code>
array if we want:</p>

<pre data-type="programlisting" data-code-language="c"><code class="o">---</code>
<code class="n">byte</code> <code class="n">colors</code><code class="p">[</code><code class="mi">8</code><code class="p">][</code><code class="mi">3</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code>
  <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code> <code class="p">},</code>
  <code class="p">{</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0x33</code><code class="p">,</code> <code class="mh">0x77</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code>
  <code class="p">{</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code>
  <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x77</code><code class="p">,</code> <code class="mh">0x33</code> <code class="p">}</code>
<code class="p">};</code>
<code class="o">---</code></pre>

<p>We could also store them in a single, simple array and do the tiny amount of math
required to get the green and blue index values as needed:</p>

<pre data-type="programlisting" data-code-language="c"><code class="o">---</code>
<code class="n">byte</code> <code class="n">colors</code><code class="p">[]</code> <code class="o">=</code> <code class="p">{</code>
  <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code>   <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code>
  <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code>   <code class="mh">0x33</code><code class="p">,</code> <code class="mh">0x77</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code>
  <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code>   <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code>
  <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code>   <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x77</code><code class="p">,</code> <code class="mh">0x33</code>
<code class="p">};</code>
<code class="o">---</code></pre>

<p>What’s more, both options save us eight bytes of storage! Since both options require
either a second index or a bit of math on the lone index, it’s up to you which
feels easier. Here’s how we can alter both the initial show
in <code>setup()</code> and the more interesting uses in <code>loop()</code> with the two-dimensional approach:</p>

<pre data-type="programlisting" data-code-language="c"><code class="kt">void</code> <code class="nf">setup</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// ...</code>
  <code class="k">for</code> <code class="p">(</code><code class="n">byte</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">p</code> <code class="o">&lt;</code> <code class="n">LED_COUNT</code><code class="p">;</code> <code class="n">p</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">0</code><code class="p">],</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">1</code><code class="p">],</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">2</code><code class="p">]);</code>
  <code class="p">}</code>
  <code class="c1">// ...</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">loop</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// ...</code>
  <code class="k">for</code> <code class="p">(</code><code class="n">byte</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">p</code> <code class="o">&lt;</code> <code class="n">LED_COUNT</code><code class="p">;</code> <code class="n">p</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">byte</code> <code class="n">red</code>   <code class="o">=</code> <code class="p">(</code><code class="n">byte</code><code class="p">)(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">);</code>
    <code class="n">byte</code> <code class="n">green</code> <code class="o">=</code> <code class="p">(</code><code class="n">byte</code><code class="p">)(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">1</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">);</code>
    <code class="n">byte</code> <code class="n">blue</code>  <code class="o">=</code> <code class="p">(</code><code class="n">byte</code><code class="p">)(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">2</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">);</code>
    <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">red</code><code class="p">,</code> <code class="n">green</code><code class="p">,</code> <code class="n">blue</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="c1">// ...</code>
<code class="p">}</code></pre>

<p>That definitely feels simpler. And while it isn’t always true, one of the
things I love about C is that looks are rarely deceiving. C can certainly work
magic on small devices, but that magic is usually out in the open. So writing
clean, simple code often increases both<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="arrays" data-startref="ardmicro-optimize-array" id="idm45018715513720"/><a data-type="indexterm" data-primary="optimization" data-secondary="with arrays" data-secondary-sortas="arrays" data-startref="optimize-array" id="idm45018715512392"/><a data-type="indexterm" data-primary="arrays" data-secondary="optimization with" data-startref="array-optimization" id="idm45018715414872"/><a data-type="indexterm" data-primary="integer math" data-secondary="avoiding with arrays" data-startref="integer-array" id="idm45018715413656"/> readability <em>and</em> performance.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Lookup Tables"><div class="sect2" id="smallerc-CHP-10-SECT-2.3">
<h2>Lookup Tables</h2>

<p>While not<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="lookup tables" id="ardmicro-optimize-lookup"/><a data-type="indexterm" data-primary="optimization" data-secondary="with lookup tables" data-secondary-sortas="lookup tables" id="optimize-lookup"/><a data-type="indexterm" data-primary="lookup tables" id="lookup"/> quite as good as no math, performing a common calculation just once and
then storing the answer for reuse is a close second. If we look at the calculations
we’re performing inside our <code>loop()</code> function, there are basically two:
one to convert the current <code>millis()</code> value into a fraction, and then one to
apply that function to our color channels (albeit separately for each channel). It
would be great to get rid of those calculations.</p>

<p>When you have more storage space than processing power (another trade-off), a popular trick
is to use <em>lookup tables</em>. You essentially run every calculation you need ahead of time,
and store the answers in an array. Then when you need one of those answers, all
you have to do is pluck the correct entry out of that array.</p>

<p>Depending on how expensive the calculation you want to store actually is, you have
two options for creating your lookup table. If it’s not too expensive, you can
build the table up at runtime before it’s needed. (For example, in an Arduino
project, we can use the <code>setup()</code> function to do this work. Then we read from the
array in the <code>loop()</code> function.) If the calculation is just impossibly expensive,
you can do all the work “offline” and then simply transcribe the results
into your program and initialize your array with a litany of literal values.</p>

<p>With limited memory, this type of optimization won’t always make sense. Filling
up a large global array might put too much of a squeeze on the rest of your program. But if the calculation is expensive enough, even reading from the slightly slower flash memory becomes feasible and you can store your lookup table there. In the latter case, of course, you have to do the offline calculation and initialize the array in <code>PROGMEM</code> when you <a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="lookup tables" data-startref="ardmicro-optimize-lookup" id="idm45018715400488"/><a data-type="indexterm" data-primary="optimization" data-secondary="with lookup tables" data-secondary-sortas="lookup tables" data-startref="optimize-lookup" id="idm45018715398952"/><a data-type="indexterm" data-primary="lookup tables" data-startref="lookup" id="idm45018715397464"/>declare it.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="The Project So Far"><div class="sect2" id="smallerc-CHP-10-SECT-2.4">
<h2>The Project So Far</h2>

<p>Let’s put <a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="LED lights example" id="ardmicro-optimize-led"/><a data-type="indexterm" data-primary="optimization" data-secondary="LED lights example" id="optimize-led"/><a data-type="indexterm" data-primary="LED lights" data-secondary="optimization example" id="LED-optimize"/>our lookup table (we’ll build ours in <code>setup()</code>) and our
simpler math to work.
When you do sit down to optimize one of your projects, it’s a good idea to try
out your ideas in small steps. This incremental approach makes it less likely you’ll
break anything. But when you do break something, the incremental approach should make
it easier to fix—or rip out and start over if worse comes to worst. Here’s
<a href="https://oreil.ly/eDKmd"><em>ch10/optimize2/optimize2.ino</em></a>:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#</code><code class="cp">include &lt;Adafruit_NeoPixel.h&gt;</code><code class="cp">
</code><code>
</code><code class="cp">#</code><code class="cp">define LED_PIN     4</code><code class="cp">
</code><code class="cp">#</code><code class="cp">define LED_COUNT   8</code><code class="cp">
</code><code class="cp">#</code><code class="cp">define RATE     5000</code><code class="cp">
</code><code>
</code><code class="n">Adafruit_NeoPixel</code><code> </code><code class="nf">stick</code><code class="p">(</code><code class="n">LED_COUNT</code><code class="p">,</code><code> </code><code class="n">LED_PIN</code><code class="p">,</code><code> </code><code class="n">NEO_GRB</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="n">byte</code><code> </code><code class="n">colors</code><code class="p">[</code><code class="mi">8</code><code class="p">]</code><code class="p">[</code><code class="mi">3</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code>                                    </code><a class="co" id="co_faster_code_CO1-1" href="#callout_faster_code_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a><code>
  </code><code class="p">{</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code> </code><code class="p">}</code><code class="p">,</code><code> </code><code class="p">{</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code> </code><code class="p">}</code><code class="p">,</code><code>
</code><code>  </code><code class="p">{</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code> </code><code class="p">}</code><code class="p">,</code><code> </code><code class="p">{</code><code> </code><code class="mh">0x33</code><code class="p">,</code><code> </code><code class="mh">0x77</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code> </code><code class="p">}</code><code class="p">,</code><code>
</code><code>  </code><code class="p">{</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code> </code><code class="p">}</code><code class="p">,</code><code> </code><code class="p">{</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code> </code><code class="p">}</code><code class="p">,</code><code>
</code><code>  </code><code class="p">{</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0x00</code><code> </code><code class="p">}</code><code class="p">,</code><code> </code><code class="p">{</code><code> </code><code class="mh">0xFF</code><code class="p">,</code><code> </code><code class="mh">0x77</code><code class="p">,</code><code> </code><code class="mh">0x33</code><code> </code><code class="p">}</code><code>
</code><code class="p">}</code><code class="p">;</code><code>
</code><code>
</code><code class="kt">uint8_t</code><code> </code><code class="n">breaths</code><code class="p">[</code><code class="mi">256</code><code class="p">]</code><code class="p">;</code><code>                                    </code><a class="co" id="co_faster_code_CO1-2" href="#callout_faster_code_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a><code>

</code><code class="kt">void</code><code> </code><code class="nf">setup</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>  </code><code class="n">Serial</code><code class="p">.</code><code class="n">begin</code><code class="p">(</code><code class="mi">115200</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">stick</code><code class="p">.</code><code class="n">begin</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>            </code><code class="c1">// Initialize our LEDs
</code><code>  </code><code class="n">stick</code><code class="p">.</code><code class="n">setBrightness</code><code class="p">(</code><code class="mi">80</code><code class="p">)</code><code class="p">;</code><code>  </code><code class="c1">// Set a comfortable brightness
</code><code>  </code><code class="c1">// Show our colors for a few seconds before animating
</code><code>  </code><code class="k">for</code><code> </code><code class="p">(</code><code class="n">byte</code><code> </code><code class="n">p</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code><code> </code><code class="n">p</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">LED_COUNT</code><code class="p">;</code><code> </code><code class="n">p</code><code class="o">+</code><code class="o">+</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>    </code><code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code><code>                               </code><a class="co" id="co_faster_code_CO1-3" href="#callout_faster_code_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a><code>
        </code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code class="p">,</code><code> </code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="p">}</code><code>
</code><code>  </code><code class="n">stick</code><code class="p">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="c1">// Now initialize our sine lookup table
</code><code>  </code><code class="k">for</code><code> </code><code class="p">(</code><code class="kt">int</code><code> </code><code class="n">s</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code><code> </code><code class="n">s</code><code> </code><code class="o">&lt;</code><code class="o">=</code><code> </code><code class="mi">255</code><code class="p">;</code><code> </code><code class="n">s</code><code class="o">+</code><code class="o">+</code><code class="p">)</code><code> </code><code class="p">{</code><code>                       </code><a class="co" id="co_faster_code_CO1-4" href="#callout_faster_code_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a><code>
    </code><code class="n">breaths</code><code class="p">[</code><code class="n">s</code><code class="p">]</code><code> </code><code class="o">=</code><code> </code><code class="n">stick</code><code class="p">.</code><code class="n">sine8</code><code class="p">(</code><code class="n">s</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="p">}</code><code>
</code><code>  </code><code class="n">delay</code><code class="p">(</code><code class="mi">2000</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code><code>
</code><code>
</code><code class="kt">void</code><code> </code><code class="nf">loop</code><code class="p">(</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>  </code><code class="kt">uint8_t</code><code> </code><code class="n">ms</code><code> </code><code class="o">=</code><code> </code><code class="p">(</code><code class="n">millis</code><code class="p">(</code><code class="p">)</code><code> </code><code class="o">%</code><code> </code><code class="n">RATE</code><code class="p">)</code><code> </code><code class="o">/</code><code> </code><code class="mi">20</code><code class="p">;</code><code>                   </code><a class="co" id="co_faster_code_CO1-5" href="#callout_faster_code_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a><code>
  </code><code class="kt">uint8_t</code><code> </code><code class="n">breath</code><code> </code><code class="o">=</code><code> </code><code class="n">breaths</code><code class="p">[</code><code class="n">ms</code><code class="p">]</code><code class="p">;</code><code>                          </code><a class="co" id="co_faster_code_CO1-6" href="#callout_faster_code_CO1-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a><code>
  </code><code class="k">for</code><code> </code><code class="p">(</code><code class="n">byte</code><code> </code><code class="n">p</code><code> </code><code class="o">=</code><code> </code><code class="mi">0</code><code class="p">;</code><code> </code><code class="n">p</code><code> </code><code class="o">&lt;</code><code> </code><code class="n">LED_COUNT</code><code class="p">;</code><code> </code><code class="n">p</code><code class="o">+</code><code class="o">+</code><code class="p">)</code><code> </code><code class="p">{</code><code>
</code><code>    </code><code class="n">byte</code><code> </code><code class="n">red</code><code>   </code><code class="o">=</code><code> </code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code><code class="p">[</code><code class="mi">0</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">breath</code><code> </code><code class="o">/</code><code> </code><code class="mi">255</code><code class="p">;</code><code>
</code><code>    </code><code class="n">byte</code><code> </code><code class="n">green</code><code> </code><code class="o">=</code><code> </code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code><code class="p">[</code><code class="mi">1</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">breath</code><code> </code><code class="o">/</code><code> </code><code class="mi">255</code><code class="p">;</code><code>
</code><code>    </code><code class="n">byte</code><code> </code><code class="n">blue</code><code>  </code><code class="o">=</code><code> </code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">]</code><code class="p">[</code><code class="mi">2</code><code class="p">]</code><code> </code><code class="o">*</code><code> </code><code class="n">breath</code><code> </code><code class="o">/</code><code> </code><code class="mi">255</code><code class="p">;</code><code>
</code><code>    </code><code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code><code> </code><code class="n">red</code><code class="p">,</code><code> </code><code class="n">green</code><code class="p">,</code><code> </code><code class="n">blue</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="p">}</code><code>
</code><code>  </code><code class="n">stick</code><code class="p">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code><code class="p">;</code><code>
</code><code>  </code><code class="n">delay</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code><code class="p">;</code><code>
</code><code class="p">}</code></pre>
<dl class="calloutlist">
<dt><a class="co" id="callout_faster_code_CO1-1" href="#co_faster_code_CO1-1"><img src="Images/1.png" alt="1" width="12" height="12"/></a></dt>
<dd><p>Break out our pixel colors into a two-dimensional array (for easier calculations in <code>loop()</code>).</p></dd>
<dt><a class="co" id="callout_faster_code_CO1-2" href="#co_faster_code_CO1-2"><img src="Images/2.png" alt="2" width="12" height="12"/></a></dt>
<dd><p>Make a global for our lookup table so we can initialize it in <code>setup()</code> and refer to it in <code>loop()</code>.</p></dd>
<dt><a class="co" id="callout_faster_code_CO1-3" href="#co_faster_code_CO1-3"><img src="Images/3.png" alt="3" width="12" height="12"/></a></dt>
<dd><p>Use an alternate function to set the pixel colors that accepts the red, green, and blue values individually.</p></dd>
<dt><a class="co" id="callout_faster_code_CO1-4" href="#co_faster_code_CO1-4"><img src="Images/4.png" alt="4" width="12" height="12"/></a></dt>
<dd><p>Fill in our sine value lookup table using the handy (and speedy) <code>sine8()</code> function from the NeoPixel library.</p></dd>
<dt><a class="co" id="callout_faster_code_CO1-5" href="#co_faster_code_CO1-5"><img src="Images/5.png" alt="5" width="12" height="12"/></a></dt>
<dd><p>Simplify our translation from milliseconds to lookup index.</p></dd>
<dt><a class="co" id="callout_faster_code_CO1-6" href="#co_faster_code_CO1-6"><img src="Images/6.png" alt="6" width="12" height="12"/></a></dt>
<dd><p>Now put our lookup table value to use in calculating the current brightness.</p></dd>
</dl>

<p>You can certainly give this a try on your controller, but hopefully the behavior of your
LED strip is the same. The intent is to make sure you understand the changes we made before
tackling more<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="LED lights example" data-startref="ardmicro-optimize-led" id="idm45018714971816"/><a data-type="indexterm" data-primary="optimization" data-secondary="LED lights example" data-startref="optimize-led" id="idm45018714757768"/><a data-type="indexterm" data-primary="LED lights" data-secondary="optimization example" data-startref="LED-optimize" id="idm45018714756552"/> tweaks.</p>
<div data-type="warning" epub:type="warning"><h6>Warning</h6>
<p>Notice that I<a data-type="indexterm" data-primary="int (variable type)" id="idm45018714993512"/><a data-type="indexterm" data-primary="variables" data-secondary="types" data-tertiary="int" id="idm45018714992456"/><a data-type="indexterm" data-primary="types (variables)" data-secondary="int" id="idm45018714916504"/><a data-type="indexterm" data-primary="byte (variable type)" id="idm45018714915592"/><a data-type="indexterm" data-primary="variables" data-secondary="types" data-tertiary="byte" id="idm45018714914920"/><a data-type="indexterm" data-primary="types (variables)" data-secondary="byte" id="idm45018714913704"/> used an <code>int</code> variable for the <code>breaths</code> array initialization. Since we
need to go right to the edge of what a <code>byte</code> can store (namely, we need to use 255),
we can’t use a byte-sized variable for the index value. The adjustment step where we increment
<code>s</code> will occur one more time when <code>s</code> is 255, pushing it to 256. Except that for a <code>byte</code>
variable, that push will force the variable to rollover back to 0. After that
rollover, we check the loop condition. Since 0 is less than or equal to 255, we
keep going. I made this mistake the first time I wrote up the initialization loop. It
took me a few minutes to figure out why the <code>setup()</code> function never ended!</p>
</div>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="The Power of Powers of 2"><div class="sect1" id="smallerc-CHP-10-SECT-4">
<h1>The Power of Powers of 2</h1>

<p>One more<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="powers of 2" id="ardmicro-optimize-powers"/><a data-type="indexterm" data-primary="optimization" data-secondary="powers of 2" id="optimize-powers"/><a data-type="indexterm" data-primary="powers of 2 optimization" id="powers-optimize"/><a data-type="indexterm" data-primary="multiplication, optimization of" id="multi-optimize"/><a data-type="indexterm" data-primary="division, optimization of" id="div-optimize"/><a data-type="indexterm" data-primary="remainder, optimization of" id="remain-optimize"/><a data-type="indexterm" data-primary="bitwise operators" data-secondary="optimization with" id="bitwise-optimize"/> math-related optimization to keep in your bag of tricks: use bitwise operations
instead of multiplication and division. Multiplication is not cheap. Division is downright expensive.
On microcontrollers, these operations can be <em>very</em> expensive—except when you are multiplying
or dividing by 2 or a power of 2 (i.e., 4, 8, 1024, etc.). The remainder operation (<code>%</code>) is really
a division operation as well, so it is also expensive, except where a power of 2 can be used.</p>

<p>We have removed a lot of expensive steps from our breathing loop, but we do still have
some remainder and division operations. Let’s see how powers of 2 help on these
calculations.</p>

<p>When we multiply a color by our <code>breath</code> variable and divide by 255 to get the correct
shade of that color, we’re trying to make sure that the shade is somewhere in the
0 to 255 range. That fraction we create has a denominator tanalizingly close to a power
of 2, namely 255 is almost 256. For example, consider our brightest red. Ideally, we would display the value 255 on our LED. The calculation we currently use looks like this:</p>

<pre data-type="programlisting" data-code-language="c">  <code class="n">red</code> <code class="o">=</code> <code class="n">red</code> <code class="o">*</code> <code class="n">breath</code> <code class="o">/</code> <code class="mi">255</code><code class="p">;</code>
  <code class="c1">//  = 255 *   255  / 255;</code>
  <code class="c1">//  = 65025 / 255;</code>
  <code class="c1">//  = 255</code></pre>

<p>This calculation results in 255, which is exactly what we want. But I said dividing by
256 would speed things up. I’ll show you how shortly, but first let’s
explore an important question: is it OK to divide by 256 rather than 255?
Well, 65025 / 256 is ~254.004. For an LED,
that is definitely close enough. So how is dividing by 256 faster than dividing
by 255?</p>

<p>It turns out that for computers with their binary brains, dividing by a power of two is
the same thing as using the right shift operator, <code>&gt;&gt;</code>. That is marvelously fast
compared to division. So our <code>red</code> approximation can now be calculated like this:</p>

<pre data-type="programlisting" data-code-language="c">  <code class="n">red</code> <code class="o">=</code> <code class="p">(</code><code class="n">red</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code></pre>

<p>You simply shift by the “power” part of your power of 2; e.g., dividing
by 2 (2<sup>1</sup>) means shifting right by 1. Dividing by 256 (2<sup>8</sup>)
means shifting right by 8. Multiplication by a power of 2,
then, works the same way; you just shift left. Need to quadruple a value? Shift it
left by 2 (2<sup>2</sup> == 4). Neat! And more importantly, speedy. All the computer has to
do is scoot some bits left or right. That type of work is very simple compared to
the algorithms for multiplying and dividing, even though the results are the same.</p>

<p>But what about remainders? They are just as expensive as division since you perform
the division on the way to finding the leftover amount. But if you are using <code>%</code> and a
power of two, that can be expressed with the bitwise <code>&amp;</code> operation and the correct <em>mask</em>.
You’ll <a data-type="indexterm" data-primary="masks" id="idm45018714723112"/>often hear about bit “masks,” which are simply numbers that keep
certain bits but hide (or mask) others. To find the remainder of a division by 64 (2<sup>6</sup>),
say, you create a mask of 6 bits: 0x3f. (That turns out to be 63, or 64–1.)
If we were to adjust our breathing rate to about four seconds (4096 milliseconds, or 2<sup>12</sup>, to be precise), we could rewrite our millisecond conversion like this:</p>

<pre data-type="programlisting" data-code-language="c">  <code class="kt">uint8_t</code> <code class="n">ms</code> <code class="o">=</code> <code class="p">(</code><code class="n">millis</code><code class="p">()</code> <code class="o">&amp;</code> <code class="mh">0x0fff</code><code class="p">)</code> <code class="o">/</code> <code class="mi">20</code><code class="p">;</code>  <code class="c1">// Bit mask with 12 bits</code></pre>

<p>And since we really want that <code>ms</code> value to lie in the range of 0 to 255 so it is an
appropriate index into our lookup table, we can turn that division into another shift
operaion with a small adjustment to our divisor (5000 / 20 is roughly 4095 / 16):</p>

<pre data-type="programlisting" data-code-language="c">  <code class="kt">uint8_t</code> <code class="n">ms</code> <code class="o">=</code> <code class="p">(</code><code class="n">millis</code><code class="p">()</code> <code class="o">&amp;</code> <code class="mh">0x0fff</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">4</code><code class="p">;</code></pre>

<p>Not bad. Not bad at all. We did have to fudge our breath rate, though. Remember my caveat
at the top of the chapter: if it’s working, it’s working! If you get a satisfactory
animation with all the floating-point math and nice round numbers like 5 seconds, your
project is a success. But if you aren’t getting the results you want, consider making
adjustments to take advantage of these optimization <a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="powers of 2" data-startref="ardmicro-optimize-powers" id="idm45018714642584"/><a data-type="indexterm" data-primary="optimization" data-secondary="powers of 2" data-startref="optimize-powers" id="idm45018714641256"/><a data-type="indexterm" data-primary="powers of 2 optimization" data-startref="powers-optimize" id="idm45018714640072"/><a data-type="indexterm" data-primary="multiplication, optimization of" data-startref="multi-optimize" id="idm45018714639160"/><a data-type="indexterm" data-primary="division, optimization of" data-startref="div-optimize" id="idm45018714609640"/><a data-type="indexterm" data-primary="remainder, optimization of" data-startref="remain-optimize" id="idm45018714608712"/><a data-type="indexterm" data-primary="bitwise operators" data-secondary="optimization with" data-startref="bitwise-optimize" id="idm45018714607752"/>tricks.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Loop Optimizations"><div class="sect1" id="smallerc-CHP-10-SECT-5">
<h1>Loop Optimizations</h1>

<p>We have <a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="loops" id="ardmicro-optimize-loop"/><a data-type="indexterm" data-primary="optimization" data-secondary="loops" id="optimize-loop"/><a data-type="indexterm" data-primary="looping" data-secondary="optimization" id="loops-optimize"/>one more clever alteration we could make to our breathing LED sketch to make it
run even faster.<sup><a data-type="noteref" id="idm45018714600472-marker" href="ch10.xhtml#idm45018714600472">4</a></sup>
Looping sections
often sacrifice a little performance for the sake of readable, reusable code. When performance
is the top goal, you can steal back a little of that speed by reducing that reusability.</p>








<section data-type="sect2" data-pdf-bookmark="Unrolling for Fun and Profit"><div class="sect2" id="smallerc-CHP-10-SECT-5.1">
<h2>Unrolling for Fun and Profit</h2>

<p>The <a data-type="indexterm" data-primary="unrolling loops" id="idm45018714597304"/>motivation behind this optimization is that it takes a little bit of time to manage a loop.
In our <code>loop()</code> function, we have a <code>for</code> loop that sets the color for each LED on our
little stick. After one LED has been updated, we have to increment the <code>p</code> variable
and then test to see if there are more LEDs to process. Those few steps are tiny, but
they are not nothing. If you are counting microseconds, this might not be time you can spare.</p>

<p>To get those microseconds back, you can <em>unroll</em> or <em>unwind</em> your loop. Basically, you take
the body of your loop and simply copy it once for every iteration required, then hardcode the
controlling variable (<code>p</code> in our case). I want you to try some of this optimizing as good practice,
so I won’t fully unwind the <code>for</code> loop. We can also use the <code>&gt;&gt;</code> trick to replace the
division required when calculating the red/blue/green values. Updating the first couple LEDs would then look like this:</p>

<pre data-type="programlisting" data-code-language="c"><code class="kt">void</code> <code class="nf">loop</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">uint8_t</code> <code class="n">ms</code> <code class="o">=</code> <code class="p">(</code><code class="n">millis</code><code class="p">()</code> <code class="o">&amp;</code> <code class="mh">0x0fff</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">4</code><code class="p">;</code>
  <code class="kt">uint8_t</code> <code class="n">breath</code> <code class="o">=</code> <code class="n">breaths</code><code class="p">[</code><code class="n">ms</code><code class="p">];</code>

  <code class="n">byte</code> <code class="n">red</code><code class="p">,</code> <code class="n">green</code><code class="p">,</code> <code class="n">blue</code><code class="p">;</code>

  <code class="c1">// Pixel 0</code>
  <code class="n">red</code>   <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
  <code class="n">green</code> <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">1</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
  <code class="n">blue</code>  <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="mi">0</code><code class="p">][</code><code class="mi">2</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="mi">0</code><code class="p">,</code> <code class="n">red</code><code class="p">,</code> <code class="n">green</code><code class="p">,</code> <code class="n">blue</code><code class="p">);</code>

  <code class="c1">// Pixel 1</code>
  <code class="n">red</code>   <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="mi">1</code><code class="p">][</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
  <code class="n">green</code> <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="mi">1</code><code class="p">][</code><code class="mi">1</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
  <code class="n">blue</code>  <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="mi">1</code><code class="p">][</code><code class="mi">2</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="mi">1</code><code class="p">,</code> <code class="n">red</code><code class="p">,</code> <code class="n">green</code><code class="p">,</code> <code class="n">blue</code><code class="p">);</code>

  <code class="c1">// Pixel 2</code>
  <code class="c1">// ...</code>

  <code class="n">stick</code><code class="p">.</code><code class="n">show</code><code class="p">();</code>
  <code class="n">delay</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>As with other optimizations, there is a trade-off here: we will consume more program space
with the unrolled loop. But again, we’re here for performance—as long as we have
the space. Just make sure you get the loop working correctly before you unroll it. Any bug
hiding in an unrolled loop will require tedious copying and pasting to fix each and every expanded chunk.</p>
</div></section>













<section data-type="sect2" data-pdf-bookmark="Recursion Versus Iteration"><div class="sect2" id="smallerc-CHP-10-SECT-5.2">
<h2>Recursion Versus Iteration</h2>

<p>There is <a data-type="indexterm" data-primary="recursive functions" data-secondary="optimization of" id="idm45018714573720"/>another loop option that is not quite an optimization, but one worth mentioning.
On devices with limited memory, recursive algorithms can run amok rather quickly.
Happily, every recursive algorithm can also be written iteratively. Sometimes the loop
approach is not intuitive or looks unwieldy, but it will work. If you are worried about
recursive calls in your code, consider converting them into a loop with some extra variables
to help out.</p>

<p>As a quick demonstration, let’s look at a loop approach to finding the nth Fibonacci
number (to replace the recursive algorithm we coded up back in <a data-type="xref" href="ch05.xhtml#smallerc-CHP-5-SECT-5.1">“Recursive Functions”</a>).
We can use a <code>for</code> loop and three variables:</p>

<pre data-type="programlisting" data-code-language="c"><code class="kt">int</code> <code class="n">find</code> <code class="o">=</code> <code class="mi">8</code><code class="p">;</code> <code class="c1">// we want the 8th Fibonacci number in this example</code>
<code class="kt">int</code> <code class="n">antepenultimate</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="c1">// F(n - 2)</code>
<code class="kt">int</code> <code class="n">penultimate</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>     <code class="c1">// F(n - 1)</code>
<code class="kt">int</code> <code class="n">ultimate</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>        <code class="c1">// F(n)</code>

<code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">f</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code> <code class="n">f</code> <code class="o">&lt;</code> <code class="n">find</code><code class="p">;</code> <code class="n">f</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
  <code class="n">antepenultimate</code> <code class="o">=</code> <code class="n">penultimate</code><code class="p">;</code>
  <code class="n">penultimate</code> <code class="o">=</code> <code class="n">ultimate</code><code class="p">;</code>
  <code class="n">ultimate</code> <code class="o">=</code> <code class="n">penultimate</code> <code class="o">+</code> <code class="n">antepenultimate</code><code class="p">;</code>
<code class="p">}</code>
<code class="c1">// After the loop completes, ultimate contains the answer, 21</code></pre>

<p>You might recall that the recursive algorithm got sluggish with larger numbers.
That won’t happen here. The numbers will eventually grow quite large, so you
might need something like a <code>long long</code> to store the results, but the algorithm would
continue to run quickly. So why don’t we always use the iterative option?
It’s not obvious with the Fibonacci series, but sometimes the recursive
algorithm is simply, well, simpler (occasionally <em>much</em> simpler) to understand
and translate into code.</p>

<p>Again we have a trade-off: complexity versus performance. In this case, though,
the trade-off may be a no-brainer. If you can’t finish performing a calculation,
using a potentially more complex algorithm that <em>can</em> complete the<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="loops" data-startref="ardmicro-optimize-loop" id="idm45018714361560"/><a data-type="indexterm" data-primary="optimization" data-secondary="loops" data-startref="optimize-loop" id="idm45018714360072"/><a data-type="indexterm" data-primary="looping" data-secondary="optimization" data-startref="loops-optimize" id="idm45018714358856"/> calculation will win.</p>
</div></section>





</div></section>













<section data-type="sect1" data-pdf-bookmark="String Versus char[]"><div class="sect1" id="smallerc-CHP-10-SECT-6">
<h1>String Versus char[]</h1>

<p>The <code>String</code> class<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="strings" id="ardmicro-optimize-strings"/><a data-type="indexterm" data-primary="optimization" data-secondary="strings" id="optimize-strings"/><a data-type="indexterm" data-primary="String (variable type)" id="string-variable-type"/><a data-type="indexterm" data-primary="strings" data-secondary="optimization" id="strings-optimize"/><a data-type="indexterm" data-primary="variables" data-secondary="types" data-tertiary="String" id="variables-types-string"/><a data-type="indexterm" data-primary="types (variables)" data-secondary="String" id="types-variables-string"/> that you can use with the Arduino IDE for storing and processing
text is another candidate for optimization. Our simple LED project didn’t really
use any text, but if you tackle any projects with text output, say on a mini LCD screen
or over a WiFi connection, you may be tempted to use <code>String</code> as it has some convenient
features. If you are running out of room, though, consider using (and reusing) boring old
<code>char[]</code> variables.</p>

<p>Many examples you’ll find online make use of <code>String</code> precisely because of
those 
<span class="keep-together">convenient</span> extras like converting numbers to text in a given base, or functions
like 
<span class="keep-together"><code>toLowerCase()</code>,</span> or using the <code>+</code> operator to concatenate <code>String</code> objects together.
(You can read about all of these extras in the
<a href="https://oreil.ly/8SZ50">String documentation</a>.)
The examples with <code>String</code> read well, and the text involved is often incidental to the project.</p>

<p>But if you are doing something more serious with text like driving an LED or LCD display,
or shipping JSON blobs to a web service (we’ll do something similar in <a data-type="xref" href="ch12.xhtml#smallerc-CHP-12-SECT-1.1">“IoT and Arduino”</a>),
the convenience of all those <code>String</code> objects flying around can start to eat into your
SRAM. Using an array of characters that you control can keep that memory consumption to
a minimum. At the very least, you’ll be aware of exactly how much room is required
to accomplish your goals.</p>

<p>Don’t forget that you can store text in flash for on-demand use as we saw in
<a data-type="xref" href="ch09.xhtml#smallerc-CHP-9-SECT-3.1">“Flash (PROGMEM)”</a>. Sometimes that <code>F()</code> macro is all you need. But relying on flash will
slow your program down a little bit and you can’t programmatically alter those messages you store
in flash. The control you get with <code>char[]</code> can be a win all around; the trade-off here
is your time and<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="strings" data-startref="ardmicro-optimize-strings" id="idm45018714336824"/><a data-type="indexterm" data-primary="optimization" data-secondary="strings" data-startref="optimize-strings" id="idm45018714335272"/><a data-type="indexterm" data-primary="String (variable type)" data-startref="string-variable-type" id="idm45018714334056"/><a data-type="indexterm" data-primary="strings" data-secondary="optimization" data-startref="strings-optimize" id="idm45018714333112"/><a data-type="indexterm" data-primary="variables" data-secondary="types" data-tertiary="String" data-startref="variables-types-string" id="idm45018714331896"/><a data-type="indexterm" data-primary="types (variables)" data-secondary="String" data-startref="types-variables-string" id="idm45018714330408"/> energy.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Our Final Offer"><div class="sect1" id="smallerc-CHP-10-SECT-7">
<h1>Our Final Offer</h1>

<p>Even<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="LED lights example" id="ardmicro-optimize-led2"/><a data-type="indexterm" data-primary="optimization" data-secondary="LED lights example" id="optimize-led2"/><a data-type="indexterm" data-primary="LED lights" data-secondary="optimization example" id="LED-optimize2"/> for such a simple project, there were a surprising number of optimizations available.
Here’s our final version of the project,
<a href="https://oreil.ly/J8Myy"><em>ch10/optimize3/optimize3.ino</em></a>:</p>

<pre data-type="programlisting" data-code-language="c"><code class="cp">#include &lt;Adafruit_NeoPixel.h&gt;</code>

<code class="cp">#define LED_PIN     4</code>
<code class="cp">#define LED_COUNT   8</code>

<code class="n">Adafruit_NeoPixel</code> <code class="nf">stick</code><code class="p">(</code><code class="n">LED_COUNT</code><code class="p">,</code> <code class="n">LED_PIN</code><code class="p">,</code> <code class="n">NEO_GRB</code><code class="p">);</code>
<code class="n">byte</code> <code class="n">colors</code><code class="p">[</code><code class="mi">8</code><code class="p">][</code><code class="mi">3</code><code class="p">]</code> <code class="o">=</code> <code class="p">{</code>
  <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code> <code class="p">},</code>
  <code class="p">{</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0x33</code><code class="p">,</code> <code class="mh">0x77</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code>
  <code class="p">{</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code><code class="p">,</code> <code class="mh">0xFF</code> <code class="p">},</code>
  <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x00</code> <code class="p">},</code> <code class="p">{</code> <code class="mh">0xFF</code><code class="p">,</code> <code class="mh">0x77</code><code class="p">,</code> <code class="mh">0x33</code> <code class="p">}</code>
<code class="p">};</code>

<code class="kt">uint8_t</code> <code class="n">breaths</code><code class="p">[</code><code class="mi">256</code><code class="p">];</code>

<code class="kt">void</code> <code class="nf">setup</code><code class="p">()</code> <code class="p">{</code>
  <code class="n">Serial</code><code class="p">.</code><code class="n">begin</code><code class="p">(</code><code class="mi">115200</code><code class="p">);</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">begin</code><code class="p">();</code>            <code class="c1">// Initialize our LEDs</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">setBrightness</code><code class="p">(</code><code class="mi">80</code><code class="p">);</code>  <code class="c1">// Set a comfortable brightness</code>
  <code class="c1">// Show our colors for a few seconds before animating</code>
  <code class="k">for</code> <code class="p">(</code><code class="n">byte</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">p</code> <code class="o">&lt;</code> <code class="n">LED_COUNT</code><code class="p">;</code> <code class="n">p</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">0</code><code class="p">],</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">1</code><code class="p">],</code> <code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">2</code><code class="p">]);</code>
  <code class="p">}</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">show</code><code class="p">();</code>
  <code class="c1">// Now initialize our sine lookup table</code>
  <code class="k">for</code> <code class="p">(</code><code class="kt">int</code> <code class="n">s</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">s</code> <code class="o">&lt;=</code> <code class="mi">255</code><code class="p">;</code> <code class="n">s</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">breaths</code><code class="p">[</code><code class="n">s</code><code class="p">]</code> <code class="o">=</code> <code class="n">stick</code><code class="p">.</code><code class="n">sine8</code><code class="p">(</code><code class="n">s</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="n">delay</code><code class="p">(</code><code class="mi">2000</code><code class="p">);</code>
<code class="p">}</code>

<code class="kt">void</code> <code class="nf">loop</code><code class="p">()</code> <code class="p">{</code>
  <code class="kt">uint8_t</code> <code class="n">ms</code> <code class="o">=</code> <code class="p">(</code><code class="n">millis</code><code class="p">()</code> <code class="o">&amp;</code> <code class="mh">0x0fff</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">4</code><code class="p">;</code>
  <code class="kt">uint8_t</code> <code class="n">breath</code> <code class="o">=</code> <code class="n">breaths</code><code class="p">[</code><code class="n">ms</code><code class="p">];</code>
  <code class="k">for</code> <code class="p">(</code><code class="n">byte</code> <code class="n">p</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="n">p</code> <code class="o">&lt;</code> <code class="n">LED_COUNT</code><code class="p">;</code> <code class="n">p</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="n">byte</code> <code class="n">red</code>   <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">0</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
    <code class="n">byte</code> <code class="n">green</code> <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">1</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
    <code class="n">byte</code> <code class="n">blue</code>  <code class="o">=</code> <code class="p">(</code><code class="n">colors</code><code class="p">[</code><code class="n">p</code><code class="p">][</code><code class="mi">2</code><code class="p">]</code> <code class="o">*</code> <code class="n">breath</code><code class="p">)</code> <code class="o">&gt;&gt;</code> <code class="mi">8</code><code class="p">;</code>
    <code class="n">stick</code><code class="p">.</code><code class="n">setPixelColor</code><code class="p">(</code><code class="n">p</code><code class="p">,</code> <code class="n">red</code><code class="p">,</code> <code class="n">green</code><code class="p">,</code> <code class="n">blue</code><code class="p">);</code>
  <code class="p">}</code>
  <code class="n">stick</code><code class="p">.</code><code class="n">show</code><code class="p">();</code>
  <code class="n">delay</code><code class="p">(</code><code class="mi">10</code><code class="p">);</code>
<code class="p">}</code></pre>

<p>The only change from our previous version is the use of integer math and bitwise operations in our <code>loop()</code> function. We convert the current millisecond count to an index we can use with our sine lookup table and simplify the current shade calculation for each of our red, green, and blue values. All told, this is quite the set of improvements! The extra efficiency leaves room to do other things. Now we could handle more LEDs or work on fancier animations. Or we could include some sensors and integrate their readings into our output. All in 2K of RAM. Your programmer ancestors would be proud. :)</p>

<p>But I shouldn’t forget the practice I mentioned. If you want to try your own
bit of optimizing, unroll the <code>for</code> loop like we started to do in
<a data-type="xref" href="#smallerc-CHP-10-SECT-5.1">“Unrolling for Fun and Profit”</a> and make sure the project still behaves<a data-type="indexterm" data-primary="Arduino microcontrollers" data-secondary="optimization" data-tertiary="LED lights example" data-startref="ardmicro-optimize-led2" id="idm45018714209976"/><a data-type="indexterm" data-primary="optimization" data-secondary="LED lights example" data-startref="optimize-led2" id="idm45018714208472"/><a data-type="indexterm" data-primary="LED lights" data-secondary="optimization example" data-startref="LED-optimize2" id="idm45018713937128"/> as expected.</p>
</div></section>













<section data-type="sect1" data-pdf-bookmark="Next Steps"><div class="sect1" id="smallerc-CHP-10-SECT-8">
<h1>Next Steps</h1>

<p>We’ve seen quite an array of optimization tricks in this chapter. There are other, more esoteric tricks, but they require more knowledge of the specific hardware you plan to use. I don’t have any specific exercises this time, but I hope you’ll revisit this chapter after you get some of your own Arduino projects off the ground.</p>

<p>If you end up with any useful functions that you optimize and tune to perfection,
you can put them in a custom library for reuse with future projects. You can even
publish them for others to use! Either way, Arduino makes making libraries relatively
easy. Let’s see how it’s done in the next chapter.</p>
</div></section>







<div data-type="footnotes"><p data-type="footnote" id="idm45018716293016"><sup><a href="ch10.xhtml#idm45018716293016-marker">1</a></sup> Making use of this feature requires understanding the really low-level details of your chip. That understanding comes with a pretty steep learning curve that’s well beyond our goals in this book. Even the SAM D21 heart of tiny controllers like Adafruit’s Trinket M0 has a 1000+ page datasheet for your reading pleasure!</p><p data-type="footnote" id="idm45018716049464"><sup><a href="ch10.xhtml#idm45018716049464-marker">2</a></sup> I had the distinct pleasure of upgrading my 8086 CPU with an <em>amazing</em> 8087 FPU coprocessor. I’ll leave it to you, gentle reader, to suss out the incriminating dates of this lovely bit of nostalgia.</p><p data-type="footnote" id="idm45018715776888"><sup><a href="ch10.xhtml#idm45018715776888-marker">3</a></sup> The <a href="https://oreil.ly/hMmZw">NeoPixel documentation</a> uses the type <code>uint8_t</code> rather than <code>byte</code>, so I will follow suit for the temporary variables.</p><p data-type="footnote" id="idm45018714600472"><sup><a href="ch10.xhtml#idm45018714600472-marker">4</a></sup> An important side effect of “running faster” is that you also make room for more calculations—or more complex calculations—to run in the same amount of time as your old calculations used to run. So without losing any performance, we could support longer strips of LEDs instead, or LEDs with more than just red, green, and blue channels.</p></div></div></section></div></body></html>